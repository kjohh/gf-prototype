<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoFreightMate Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar styles */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }

        /* SVG icon base styles (replace .lucide class) */
        .svg-icon {
            width: 1.1rem;
            height: 1.1rem;
            stroke-width: 2;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
            fill: none; /* Most Lucide icons don't need fill */
            stroke: currentColor; /* Default to text color */
        }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Lucide icon styles */
        .lucide { width: 1.1rem; height: 1.1rem; stroke-width: 2; display: inline-block; vertical-align: middle; margin-right: 0.5rem; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }


        /* Selected email styles */
        .email-item.selected { background-color: #e2e8f0; border-left: 3px solid #2563eb; }

        /* Unread email styles */
        .email-item.unread .font-semibold { font-weight: 700; }
        .email-item.unread .text-gray-900 { color: #111827; }
        .email-item.unread .text-blue-600 { color: #2563eb; }

        /* GoFreightMate panel styles */
        #gofreightmate-panel { z-index: 5; }

        /* GoFreightMate field styles */
        .gfm-field { margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e5e7eb; }
        .gfm-label { font-weight: 600; color: #374151; margin-bottom: 0.25rem; display: block; }
        .gfm-data { font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem; word-wrap: break-word; }
        .gfm-data.ai { color: #1d4ed8; font-weight: 500; }
        .gfm-update input { width: 100%; padding: 0.25rem 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; }
 
        /* New modern card-style field styles */
        .gfm-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }
        .gfm-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .gfm-card-header {
            margin-bottom: 0.75rem;
            border-bottom: 1px solid #f3f4f6;
            padding-bottom: 0.5rem;
        }
        .gfm-card-title {
            font-weight: 600;
            color: #4b5563;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }
        .gfm-card-title i {
            margin-right: 0.5rem;
            color: #6366f1;
        }
        .gfm-card-content {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .gfm-card-row {
            display: flex;
            flex-direction: column;
        }
        .gfm-card-label {
            font-size: 0.7rem;
            color: #6b7280;
            margin-bottom: 0.125rem;
        }
        .gfm-card-value {
            font-size: 0.875rem;
            color: #374151;
            font-weight: 500;
            word-wrap: break-word;
        }
        .gfm-card-value.ai {
            color: #4f46e5;
        }
        .gfm-card-value.current {
            color: #6b7280;
        }
        .gfm-card-input {
            margin-top: 0.5rem;
            width: 100%;
            padding: 0.375rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.15s ease-in-out;
        }
        .gfm-card-input:focus {
            border-color: #6366f1;
            outline: none;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        /* Input type specific styles */
        .gfm-date-picker {
            margin-top: 0.5rem;
            width: 100%;
            padding: 0.375rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.15s ease-in-out;
            background-color: white;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.2rem;
            padding-right: 2rem;
        }
        .gfm-date-picker:focus {
            border-color: #6366f1;
            outline: none;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
        .gfm-select-wrapper {
            margin-top: 0.5rem;
            position: relative;
        }
        .gfm-select {
            width: 100%;
            padding: 0.375rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.15s ease-in-out;
            background-color: white;
            appearance: none;
            padding-right: 2rem;
        }
        .gfm-select:focus {
            border-color: #6366f1;
            outline: none;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
        .gfm-select-arrow {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #6b7280;
        }
        .gfm-autocomplete-wrapper {
            margin-top: 0.5rem;
            position: relative;
        }
        .gfm-autocomplete-input {
            width: 100%;
            padding: 0.375rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.15s ease-in-out;
        }
        .gfm-autocomplete-input:focus {
            border-color: #6366f1;
            outline: none;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
        .gfm-autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 10;
            display: none;
        }
        .gfm-autocomplete-item {
            padding: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .gfm-autocomplete-item:hover {
            background-color: #f3f4f6;
        }
        .gfm-autocomplete-wrapper.active .gfm-autocomplete-dropdown {
            display: block;
        }

        /* HB/L No. card styles */
        .hbl-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
        }
        .hbl-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .hbl-card-title {
            font-weight: 600;
            color: #4b5563;
        }
        .hbl-card-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: #4f46e5;
            margin-top: 0.25rem;
        }
        .hbl-edit-btn {
            border: none;
            background: transparent;
            color: #6366f1;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }
        .hbl-edit-btn:hover {
            background-color: #f3f4f6;
        }
        .hbl-edit-form {
            margin-top: 0.75rem;
        }
        .hbl-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        .hbl-save-btn {
            background-color: #4f46e5;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .hbl-save-btn:hover {
            background-color: #4338ca;
        }

        /* Collapsible sidebar styles */
        #sidebar {
            transition: width 0.3s ease-in-out; /* Smooth width transition */
        }
        #sidebar.sidebar-collapsed {
            width: 4rem; /* Tailwind w-16 */
        }
         /* Hide collapsible content when sidebar is collapsed */
        #sidebar.sidebar-collapsed #sidebar-collapsible-content {
            display: none;
        }
         /* Hide Outlook text when sidebar is collapsed */
        #sidebar.sidebar-collapsed #outlook-title {
             display: none;
        }
         /* Adjust toggle button margins when sidebar is collapsed */
         #sidebar.sidebar-collapsed #sidebar-toggle-button .lucide {
              margin-right: 0; /* Remove right margin for icon */
         }
         /* Ensure header area padding is appropriate when sidebar is collapsed */
         #sidebar.sidebar-collapsed #sidebar-header {
              padding-left: 1rem; /* Adjust left padding to center icon */
              padding-right: 1rem;
         }

    </style>
</head>
<body class="bg-gray-100 font-sans flex h-screen overflow-hidden">

    <aside id="sidebar" class="w-64 bg-[#F3F2F1] border-r border-gray-300 flex flex-col flex-shrink-0">
         <div id="sidebar-header" class="p-4 flex items-center space-x-2 border-b border-gray-300 flex-shrink-0">
            <button id="sidebar-toggle-button" class="p-1 hover:bg-gray-200 rounded">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon text-gray-600 !mr-0"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
            </button>
            <span id="outlook-title" class="text-lg font-semibold text-gray-800">Outlook</span>
        </div>

        <div id="sidebar-collapsible-content" class="flex flex-col flex-1 overflow-y-auto">
            <div class="p-4">
                <button class="w-full bg-[#0078D4] text-white py-2 px-4 rounded-md shadow hover:bg-[#005A9E] transition duration-150 flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                    <span>New Email</span>
                </button>
            </div>
            <nav class="flex-1 overflow-y-auto p-2 space-y-1">
                <a href="#" class="flex items-center px-3 py-2 text-gray-700 font-medium bg-gray-200 rounded-md">
                    <i data-lucide="inbox"></i> Inbox
                    <span id="inbox-count" class="ml-auto text-xs bg-blue-500 text-white rounded-full px-2 py-0.5">0</span>
                </a>
                <a href="#" class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i data-lucide="file-text"></i> Drafts</a>
                <a href="#" class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i data-lucide="send"></i> Sent Items</a>
                <a href="#" class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i data-lucide="archive"></i> Archive</a>
                <a href="#" class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i data-lucide="trash-2"></i> Deleted Items</a>
                 <a href="#" class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i data-lucide="alert-octagon"></i> Junk Email</a>
                 <div class="pt-4">
                    <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Folders</h3>
                    <a href="#" class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-200 rounded-md mt-1"><i data-lucide="folder"></i> Customs Documents</a>
                     <a href="#" class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i data-lucide="folder"></i> Carrier Notifications</a>
                     <a href="#" class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i data-lucide="folder"></i> Customer A</a>
                </div>
            </nav>
            <div class="p-3 border-t border-gray-300 flex justify-around flex-shrink-0">
                 <i data-lucide="mail" class="text-gray-600 cursor-pointer hover:text-blue-600"></i>
                 <i data-lucide="calendar" class="text-gray-600 cursor-pointer hover:text-blue-600"></i>
                 <i data-lucide="users" class="text-gray-600 cursor-pointer hover:text-blue-600"></i>
                 <i data-lucide="paperclip" class="text-gray-600 cursor-pointer hover:text-blue-600"></i>
                 <i data-lucide="clipboard-list" class="text-gray-600 cursor-pointer hover:text-blue-600"></i>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex h-screen overflow-hidden">

        <section id="email-list-pane" class="w-96 bg-white border-r border-gray-300 flex flex-col h-full flex-shrink-0">
            <div class="p-4 border-b border-gray-300 flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-800">Inbox</h2>
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-500">Filter</span>
                    <i data-lucide="filter" class="text-gray-600 cursor-pointer hover:text-blue-600"></i>
                </div>
            </div>
            <div id="email-list" class="overflow-y-auto flex-1">
                </div>
        </section>

        <section id="reading-pane" class="flex-1 bg-white flex flex-col h-full overflow-y-auto border-r border-gray-300">
            <div id="reading-pane-placeholder" class="flex-1 flex items-center justify-center text-gray-500">
                Select an item to read
            </div>
            <div id="email-content-area" class="hidden flex-1 flex flex-col">
                <div class="p-4 border-b border-gray-300">
                    <h3 id="email-subject" class="text-xl font-semibold text-gray-800 mb-2"></h3>
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-xl flex-shrink-0" id="sender-initial"></div>
                        <div>
                            <div id="email-sender" class="font-medium text-gray-900"></div>
                            <div class="text-sm text-gray-500">To: <span id="email-recipient">You</span></div>
                        </div>
                        <div class="ml-auto text-sm text-gray-500 flex-shrink-0" id="email-timestamp"></div>
                    </div>
                     <div class="flex space-x-2 text-gray-600">
                        <button class="p-1 hover:bg-gray-200 rounded flex items-center space-x-1"><i data-lucide="reply"></i> <span>Reply</span></button>
                        <button class="p-1 hover:bg-gray-200 rounded flex items-center space-x-1"><i data-lucide="reply-all"></i> <span>Reply All</span></button>
                        <button class="p-1 hover:bg-gray-200 rounded flex items-center space-x-1"><i data-lucide="forward"></i> <span>Forward</span></button>
                        <button id="gofreightmate-button" class="hidden ml-4 p-1 bg-purple-600 text-white rounded hover:bg-purple-700 flex items-center space-x-1">
                            <i data-lucide="scan-line"></i> <span>GoFreightMate</span>
                        </button>
                        <button class="ml-auto p-1 hover:bg-gray-200 rounded"><i data-lucide="archive"></i></button>
                        <button class="p-1 hover:bg-gray-200 rounded"><i data-lucide="trash-2"></i></button>
                        <button class="p-1 hover:bg-gray-200 rounded"><i data-lucide="ellipsis"></i></button>
                    </div>
                </div>
                <div id="email-body" class="p-6 flex-1 overflow-y-auto text-gray-800 leading-relaxed">
                    </div>
            </div>
        </section>

         <aside id="gofreightmate-panel" class="w-96 h-full bg-gray-50 border-l-2 border-purple-200 shadow-lg p-4 flex-col overflow-y-auto flex-shrink-0 hidden"> <div class="flex justify-between items-center mb-4 pb-2 border-b border-purple-200 flex-shrink-0">
                <h3 class="text-lg font-semibold text-purple-800 flex items-center">
                    <i data-lucide="scan-line" class="text-purple-600"></i> GoFreightMate AI</h3>
                <button id="gofreightmate-close-button" class="p-1 text-purple-500 hover:text-purple-700 hover:bg-purple-100 rounded">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div id="hbl-section" class="hidden">
                <div class="hbl-card">
                    <div class="hbl-card-header">
                        <div class="hbl-card-title">HB/L No.</div>
                        <button id="hbl-edit-button" class="hbl-edit-btn">
                            <i data-lucide="edit-3" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div id="hbl-display" class="hbl-card-value">EGLV1234567890</div>
                    <div id="hbl-edit-form" class="hbl-edit-form hidden">
                        <input type="text" id="hbl-input" class="hbl-input" value="EGLV1234567890">
                        <button id="hbl-save-button" class="hbl-save-btn">Confirm</button>
                    </div>
                </div>
            </div>
            <div id="gofreightmate-content" class="flex-1">
                <p class="text-center text-purple-600">Click the GoFreightMate button above to start analysis.</p>
            </div>
             <div class="mt-auto pt-4 border-t border-purple-200 flex-shrink-0">
                 <button class="w-full bg-purple-600 text-white py-2 px-4 rounded-md shadow hover:bg-purple-700 transition duration-150 flex items-center justify-center space-x-2">
                     <i data-lucide="save"></i>
                     <span>Update GoFreight (Simulation)</span>
                 </button>
            </div>
        </aside>
    </main>

    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script>
        // Simulated email data for ocean import operator
        const emails = [
             { id: 1, sender: 'Maersk Line', senderInitial: 'M', subject: 'ETA Update - Vessel MAERSK HONG KONG V.2401 - Container MSKU1234567', snippet: 'Please note that the updated ETA for MAERSK HONG KONG V.2401 at Los Angeles port is now...', timestamp: '9:45 AM', unread: true, body: `<p>Dear Customer,</p><p>Please be advised that the vessel <strong>MAERSK HONG KONG V.2401</strong> has an updated estimated time of arrival (ETA) at Los Angeles Port (USLAX) of <strong>April 18, 2025, 14:00 PST</strong>.</p><p>Container Number: <strong>MSKU1234567</strong></p><p>Booking Reference: <strong>AE123987</strong></p><p>We apologize for any inconvenience this schedule change may cause. You can track the latest status of the vessel on our website.</p><p>Best regards,<br>Maersk Customer Service</p>` },
             { id: 2, sender: 'Evergreen Shipping Agency', senderInitial: 'E', subject: 'Arrival Notice - EVER ACE V.015E - B/L No. EGLV1234567890', snippet: 'Your cargo on EVER ACE V.015E is scheduled to discharge on April 17. Please arrange...', timestamp: 'Yesterday', unread: true, body: `<p><strong>Arrival Notice</strong></p><p>Dear Customer,</p><p>This is to inform you that your cargo under Bill of Lading <strong>EGLV1234567890</strong> is expected to arrive at Taipei Port (TW TPE) on the vessel <strong>EVER ACE V.015E</strong>.</p><ul><li>Estimated Discharge Date: April 17, 2025</li><li>Container Number: EISU9876543</li><li>Last Free Day: April 21, 2025</li></ul><p>Please ensure timely arrangements for customs clearance and cargo collection to avoid potential demurrage charges.</p><p>Required release documents are attached.</p><p>Sincerely,<br>Evergreen Shipping Agency (America) Inc.</p>` },
             { id: 3, sender: 'Apex Logistics', senderInitial: 'A', subject: 'URGENT: Customs Examination - Cargo Ref APX55678 - Container TCNU1122334', snippet: 'Action Required: US Customs has selected shipment APX55678 for examination. Additional documents...', timestamp: 'Yesterday', unread: false, body: `<p>Team Partners,</p><p><strong>Urgent Action Notice</strong></p><p>US Customs and Border Protection (CBP) has selected the following shipment for examination (X-Ray):</p><ul><li>Our Reference: <strong>APX55678</strong></li><li>Consignee: Global Imports Inc.</li><li>Container: <strong>TCNU1122334</strong></li><li>Vessel/Voyage: OOCL TOKYO / 088W</li><li>ETA Long Beach: April 16, 2025</li></ul><p>CBP is requesting commercial invoice, packing list, and detailed product material composition information within 48 hours.</p><p>Please coordinate with the importer immediately to collect the required documents and information. Advise the client of potential delays and examination fees.</p><p>Thank you,<br>Compliance Department<br>Apex Logistics</p>` },
             { id: 4, sender: 'Port Authority NY/NJ', senderInitial: 'P', subject: 'Terminal Congestion Update - APM Terminals Elizabeth', snippet: 'APM Terminals Elizabeth yard utilization is high. Expect extended truck turn times...', timestamp: 'Apr 14', unread: false, body: `<p><strong>Operational Alert</strong></p><p>To All Port Users,</p><p>Please be advised that APM Terminals Elizabeth is currently experiencing high yard utilization due to increased import volumes.</p><p>Truck drivers may experience longer than normal turn times. We encourage advanced appointments through the terminal system and to check for real-time updates.</p><p>We are working closely with terminal operators to alleviate congestion and improve fluidity.</p><p>Thank you for your cooperation,<br>Port Authority of New York & New Jersey</p>` },
             { id: 5, sender: 'CMA CGM Group', senderInitial: 'C', subject: 'Booking Confirmation - Reference: CC100987 - POL: Shanghai / POD: Houston', snippet: 'Your booking CC100987 for 1x40\'HC from Shanghai to Houston has been confirmed on CMA CGM J. MADISON...', timestamp: 'Apr 14', unread: true, body: `<p>Dear Partner,</p><p>This email confirms your booking request:</p><ul><li>Booking Reference: <strong>CC100987</strong></li><li>Container Type: 1 x 40' High Cube (HC)</li><li>Port of Loading (POL): Shanghai, China (CNSHA)</li><li>Port of Discharge (POD): Houston, TX, USA (USHOU)</li><li>Vessel/Voyage: <strong>CMA CGM J. MADISON / 0TXAKE1MA</strong></li><li>Estimated Time of Departure (ETD) Shanghai: April 25, 2025</li><li>Estimated Time of Arrival (ETA) Houston: May 20, 2025</li></ul><p>Please ensure operations according to the container cutoff and documentation deadline specified in the booking confirmation details.</p><p>Best regards,<br>CMA CGM E-Commerce Team</p>` },
             { id: 6, sender: 'Flexport', senderInitial: 'F', subject: 'Pre-Alert: Shipment FLX98765 Arriving in Oakland', snippet: 'Pre-alert for shipment FLX98765 (Consignee: Tech Gadgets Co) arriving in Oakland on ONE OLYMPUS...', timestamp: 'Apr 13', unread: false, body: `<p>Hello Partner,</p><p>Please find the pre-alert details for the following shipment:</p><ul><li>Flexport Reference: <strong>FLX98765</strong></li><li>Consignee: Tech Gadgets Co</li><li>House B/L (HBL): FLXSHAOAK123</li><li>Master B/L (MBL): ONEXYZOAK987</li><li>Container Number: OOLU5554443 (1x40'HQ)</li><li>Vessel/Voyage: ONE OLYMPUS / 050E</li><li>ETD Shanghai: March 30, 2025</li><li>ETA Oakland: April 19, 2025</li></ul><p>Attached is a copy of the HBL, commercial invoice, and packing list for your reference and customs clearance preparation.</p><p>Please confirm receipt and advise if ISF has been filed.</p><p>Thanks,<br>Flexport Operations</p>` },
             { id: 7, sender: 'Hapag-Lloyd', senderInitial: 'H', subject: 'Rate Request - Taipei to Hamburg', snippet: 'Regarding your inquiry for rates from Taipei to Hamburg for 2x20\'GP. Please find attached quote...', timestamp: 'Apr 12', unread: true, body: `<p>Dear Customer,</p><p>Regarding your recent rate request, please find our quote attached for the following cargo:</p><ul><li>Origin: Taipei, Taiwan (TW TPE)</li><li>Destination: Hamburg, Germany (DE HAM)</li><li>Commodity: FAK (Freight All Kinds)</li><li>Container Type: 2 x 20' General Purpose (GP)</li></ul><p>The quote includes ocean freight, standard origin/destination charges, and validity details.</p><p>Please review and let us know if you wish to proceed with booking.</p><p>Best regards,<br>Hapag-Lloyd Sales Team</p>` },
             { id: 8, sender: 'Internal Operations Team', senderInitial: 'I', subject: 'Reminder: Ocean Import Status Call Today at 2 PM CST', snippet: 'Reminder that we will be holding our weekly sync to review shipment status, challenges, and priorities...', timestamp: '8:30 AM', unread: true, body: `<p>Hello Team Members,</p><p>Friendly reminder of our Ocean Import Status Call scheduled for today:</p><p><strong>Time:</strong> 2:00 - 3:00 PM CST</p><p><strong>Agenda:</strong></p><ul><li>Review of key shipments' ETAs and potential delays</li><li>Discussion of clearance issues/examinations</li><li>Handling of carrier performance and space issues</li><li>Customer escalations</li><li>Open floor/updates</li></ul><p>Please be prepared to discuss your key accounts and any urgent matters.</p><p>Meeting Link: [Meeting Link]</p><p>See you at the meeting!</p>` }
        ];

        // DOM Element References
        const sidebar = document.getElementById('sidebar');
        const sidebarToggleButton = document.getElementById('sidebar-toggle-button');
        const emailListContainer = document.getElementById('email-list');
        const readingPanePlaceholder = document.getElementById('reading-pane-placeholder');
        const emailContentArea = document.getElementById('email-content-area');
        const emailSubject = document.getElementById('email-subject');
        const emailSender = document.getElementById('email-sender');
        const senderInitial = document.getElementById('sender-initial');
        const emailRecipient = document.getElementById('email-recipient');
        const emailTimestamp = document.getElementById('email-timestamp');
        const emailBody = document.getElementById('email-body');
        const inboxCountSpan = document.getElementById('inbox-count');
        const gofreightmateButton = document.getElementById('gofreightmate-button');
        const gofreightmatePanel = document.getElementById('gofreightmate-panel');
        const gofreightmateContent = document.getElementById('gofreightmate-content');
        const gofreightmateCloseButton = document.getElementById('gofreightmate-close-button');

        let selectedEmailItem = null;
        let currentOpenEmail = null;
        let isGoFreightMatePanelOpen = false;
        let analysisTimeoutId = null;
        let lucideCheckInterval = null; // Interval timer for Lucide check
        let lucideCheckTimeout = null; // Timeout for Lucide check
        let currentHblNo = "EGLV1234567890"; // Added: current HB/L No.

        // --- Helper Functions ---
        function updateUnreadCount() {
            const unreadCount = emails.filter(email => email.unread).length;
            inboxCountSpan.textContent = unreadCount > 0 ? unreadCount : '';
        }

        function showLoadingIndicator() {
             if (!gofreightmatePanel || !gofreightmateContent) return;
             // Hide HBL section
             const hblSection = document.getElementById('hbl-section');
             if (hblSection) {
                 hblSection.classList.add('hidden');
             }
             
             gofreightmateContent.innerHTML = `
                <div class="flex justify-center items-center h-full">
                    <p class="text-center text-purple-600 flex items-center">
                        <i data-lucide="loader-2" class="animate-spin mr-2"></i> Analyzing...
                    </p>
                </div>`;
             // Ensure icon is rendered immediately after adding HTML
             // Check if lucide is available before calling
             if (typeof lucide !== 'undefined') {
                 try {
                    lucide.createIcons();
                 } catch (error) {
                     console.error("Error creating dynamic Lucide icon (loader):", error);
                 }
             } else {
                 console.error("Lucide not available when showing loading indicator.");
             }
        }

        // --- Sidebar Toggle Function ---
        function toggleSidebar() {
            if (sidebar) {
                sidebar.classList.toggle('sidebar-collapsed');
                console.log("Sidebar toggled. Collapsed state:", sidebar.classList.contains('sidebar-collapsed'));
            } else {
                console.error("Sidebar element not found for toggling.");
            }
        }

        // --- GoFreightMate Functions ---
        function triggerGoFreightMateAnalysis(email) {
            if (!email) return;
            console.log("Triggering analysis for email ID:", email.id);
             if (analysisTimeoutId) { clearTimeout(analysisTimeoutId); analysisTimeoutId = null; }
            showLoadingIndicator();
            analysisTimeoutId = setTimeout(() => {
                populateGoFreightMateContent(email);
                analysisTimeoutId = null;
            }, 1000);
        }

        function openGoFreightMatePanel() {
            console.log("GoFreightMate button clicked!");
            if (!currentOpenEmail) { console.error("Cannot open GoFreightMate: currentOpenEmail is null."); return; }
            isGoFreightMatePanelOpen = true;
            gofreightmatePanel.classList.remove('hidden');
            gofreightmatePanel.classList.add('flex');
            console.log("Panel should be visible now.");
            triggerGoFreightMateAnalysis(currentOpenEmail);
        }

        function closeGoFreightMatePanel() {
            isGoFreightMatePanelOpen = false;
            gofreightmatePanel.classList.add('hidden');
            gofreightmatePanel.classList.remove('flex');
            
            // Hide HBL section
            const hblSection = document.getElementById('hbl-section');
            if (hblSection) {
                hblSection.classList.add('hidden');
            }
            
            if (analysisTimeoutId) { clearTimeout(analysisTimeoutId); analysisTimeoutId = null; }
            gofreightmateContent.innerHTML = '<p class="text-center text-purple-600">Click the GoFreightMate button above to start analysis.</p>';
            console.log("Panel closed.");
        }

        function createFieldHtml(label, currentData, aiData, fieldType = 'text') {
            let inputHtml = '';
            
            // 根據字段類型生成不同的輸入元素
            switch(fieldType) {
                case 'date':
                    inputHtml = `
                        <input type="text" class="gfm-date-picker" value="${aiData || ''}" placeholder="YYYY-MM-DD, HH:MM">
                    `;
                    break;
                case 'vessel':
                    inputHtml = `
                        <div class="gfm-autocomplete-wrapper">
                            <input type="text" class="gfm-autocomplete-input" value="${aiData || ''}" placeholder="Start typing vessel name...">
                            <div class="gfm-autocomplete-dropdown">
                                <div class="gfm-autocomplete-item">MAERSK HONG KONG</div>
                                <div class="gfm-autocomplete-item">EVER ACE</div>
                                <div class="gfm-autocomplete-item">MSC OSCAR</div>
                                <div class="gfm-autocomplete-item">ONE OLYMPUS</div>
                                <div class="gfm-autocomplete-item">CMA CGM J. MADISON</div>
                            </div>
                        </div>
                    `;
                    break;
                case 'port':
                    inputHtml = `
                        <div class="gfm-autocomplete-wrapper">
                            <input type="text" class="gfm-autocomplete-input" value="${aiData || ''}" placeholder="Start typing port name...">
                            <div class="gfm-autocomplete-dropdown">
                                <div class="gfm-autocomplete-item">Los Angeles (USLAX)</div>
                                <div class="gfm-autocomplete-item">New York (USNYC)</div>
                                <div class="gfm-autocomplete-item">Singapore (SGSIN)</div>
                                <div class="gfm-autocomplete-item">Shanghai (CNSHA)</div>
                                <div class="gfm-autocomplete-item">Taipei (TWTPE)</div>
                                <div class="gfm-autocomplete-item">Houston (USHOU)</div>
                            </div>
                        </div>
                    `;
                    break;
                case 'location':
                    inputHtml = `
                        <div class="gfm-select-wrapper">
                            <select class="gfm-select">
                                <option value="">${aiData || 'Select a location'}</option>
                                <option value="SAMSUNG C AND T AMERICA INC.">SAMSUNG C AND T AMERICA INC.</option>
                                <option value="JONES, CLAYTON AND HARRIS">JONES, CLAYTON AND HARRIS</option>
                                <option value="PACIFIC TERMINAL">PACIFIC TERMINAL</option>
                                <option value="AMERICAN LOGISTICS">AMERICAN LOGISTICS</option>
                                <option value="GLOBAL WAREHOUSE">GLOBAL WAREHOUSE</option>
                            </select>
                            <div class="gfm-select-arrow">
                                <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </div>
                        </div>
                    `;
                    break;
                case 'container':
                    inputHtml = `
                        <input type="text" class="gfm-card-input" value="${aiData || ''}" pattern="[A-Z]{4}[0-9]{7}" placeholder="e.g., MSKU1234567">
                    `;
                    break;
                default:
                    inputHtml = `
                        <input type="text" class="gfm-card-input" value="${aiData || ''}">
                    `;
            }

            return `
                <div class="gfm-card">
                    <div class="gfm-card-header">
                        <div class="gfm-card-title">
                            <i data-lucide="clipboard-list" class="w-4 h-4"></i>
                            ${label}
                        </div>
                    </div>
                    <div class="gfm-card-content">
                        <div class="gfm-card-row">
                            <div class="gfm-card-label">GoFreight Current Data:</div>
                            <div class="gfm-card-value current">${currentData || '<i>(None)</i>'}</div>
                        </div>
                        <div class="gfm-card-row">
                            <div class="gfm-card-label">AI Extracted Data:</div>
                            <div class="gfm-card-value ai">${aiData || '<i>(Not extracted)</i>'}</div>
                        </div>
                        <div class="gfm-card-row">
                            <div class="gfm-card-label">Update Data:</div>
                            ${inputHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        function populateGoFreightMateContent(email) {
            if (!email) { 
                gofreightmateContent.innerHTML = '<p class="text-red-600">Error: Unable to read email content.</p>'; 
                return; 
            }
            console.log("Populating content for email ID:", email.id);
            gofreightmateContent.innerHTML = '';
            
            // Show HBL section
            const hblSection = document.getElementById('hbl-section');
            if (hblSection) {
                hblSection.classList.remove('hidden');
            }
            
            // Update HB/L No. display based on current email
            if (email.id === 2) {
                // Evergreen email, show EGLV1234567890
                currentHblNo = "EGLV1234567890";
                document.getElementById('hbl-display').textContent = currentHblNo;
                document.getElementById('hbl-input').value = currentHblNo;
                
                gofreightmateContent.innerHTML += createFieldHtml('Container No.', '<i>(None)</i>', 'EISU9876543', 'container');
                gofreightmateContent.innerHTML += createFieldHtml('Vessel/Voyage', 'EVER ACE / 014E', 'EVER ACE V.015E', 'vessel');
                gofreightmateContent.innerHTML += createFieldHtml('Est. Discharge Date', 'April 16, 2025', 'April 17, 2025', 'date');
                gofreightmateContent.innerHTML += createFieldHtml('Last Free Day', 'April 20, 2025', 'April 21, 2025', 'date');
                gofreightmateContent.innerHTML += createFieldHtml('POD/Location', 'Taipei Port', 'Taipei Port (TW TPE)', 'port');
                gofreightmateContent.innerHTML += createFieldHtml('CY/CFS Location', 'JONES, CLAYTON AND HARRIS', 'SAMSUNG C AND T AMERICA INC.', 'location');
            } else if (email.id === 1) {
                // Maersk email, show different HB/L
                currentHblNo = "MSKU1234567";
                document.getElementById('hbl-display').textContent = currentHblNo;
                document.getElementById('hbl-input').value = currentHblNo;
                
                gofreightmateContent.innerHTML += createFieldHtml('Container No.', 'MSKU1234567', 'MSKU1234567', 'container');
                gofreightmateContent.innerHTML += createFieldHtml('Vessel/Voyage', 'MAERSK HONG KONG / 2401', 'MAERSK HONG KONG V.2401', 'vessel');
                gofreightmateContent.innerHTML += createFieldHtml('ETA', 'April 18, 2025, 08:00 PST', 'April 18, 2025, 14:00 PST', 'date');
                gofreightmateContent.innerHTML += createFieldHtml('Destination', 'Los Angeles, CA', 'Port of Los Angeles (USLAX)', 'port');
            } else {
                // Other emails
                currentHblNo = "N/A";
                document.getElementById('hbl-display').textContent = currentHblNo;
                document.getElementById('hbl-input').value = currentHblNo;
                
                gofreightmateContent.innerHTML = '<p class="text-purple-700">GoFreightMate AI analysis is not applicable to this email type.</p>';
            }
            
            // 初始化自動完成下拉選單功能
            initializeAutoComplete();
            
            // 確保圖標被渲染
            if (typeof lucide !== 'undefined') {
                try {
                    lucide.createIcons();
                } catch (error) {
                    console.error("Error creating icons after populating content:", error);
                }
            }
        }

        // 新增自動完成下拉選單的初始化函數
        function initializeAutoComplete() {
            // 獲取所有自動完成輸入框
            const autoCompleteInputs = document.querySelectorAll('.gfm-autocomplete-input');
            
            autoCompleteInputs.forEach(input => {
                // 監聽焦點事件
                input.addEventListener('focus', function() {
                    const wrapper = this.closest('.gfm-autocomplete-wrapper');
                    wrapper.classList.add('active');
                });
                
                // 監聽失焦事件
                input.addEventListener('blur', function() {
                    // 延遲關閉下拉菜單，以便能夠點擊選項
                    setTimeout(() => {
                        const wrapper = this.closest('.gfm-autocomplete-wrapper');
                        wrapper.classList.remove('active');
                    }, 200);
                });
                
                // 監聽輸入事件實現過濾功能
                input.addEventListener('input', function() {
                    const wrapper = this.closest('.gfm-autocomplete-wrapper');
                    const dropdown = wrapper.querySelector('.gfm-autocomplete-dropdown');
                    const items = dropdown.querySelectorAll('.gfm-autocomplete-item');
                    const value = this.value.toLowerCase();
                    
                    items.forEach(item => {
                        if (item.textContent.toLowerCase().includes(value)) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                    
                    // 如果有輸入內容則顯示下拉菜單
                    if (value.length > 0) {
                        wrapper.classList.add('active');
                    }
                });
            });
            
            // 獲取所有自動完成下拉選項
            const autoCompleteItems = document.querySelectorAll('.gfm-autocomplete-item');
            
            autoCompleteItems.forEach(item => {
                // 監聽點擊事件
                item.addEventListener('click', function() {
                    const wrapper = this.closest('.gfm-autocomplete-wrapper');
                    const input = wrapper.querySelector('.gfm-autocomplete-input');
                    input.value = this.textContent;
                    wrapper.classList.remove('active');
                });
            });
        }

        // --- Email List and Reading Pane Functions ---
        function displayEmails() {
            emailListContainer.innerHTML = '';
            emails.forEach(email => {
                const emailItem = document.createElement('div');
                emailItem.classList.add('email-item', 'p-4', 'border-b', 'border-gray-200', 'cursor-pointer', 'hover:bg-gray-100', 'relative');
                if (email.unread) { emailItem.classList.add('unread'); }
                emailItem.dataset.emailId = email.id;
                emailItem.innerHTML = `
                    ${email.unread ? '<span class="absolute left-1 top-1/2 transform -translate-y-1/2 w-2 h-2 bg-blue-600 rounded-full"></span>' : ''}
                    <div class="flex justify-between items-center mb-1 pl-3"> <span class="font-semibold text-sm ${email.unread ? 'text-gray-900' : 'text-gray-700'}">${email.sender}</span> <span class="text-xs ${email.unread ? 'text-blue-600 font-medium' : 'text-gray-500'}">${email.timestamp}</span> </div>
                    <div class="text-sm ${email.unread ? 'font-semibold text-gray-900' : 'text-gray-700'} mb-1 pl-3">${email.subject}</div>
                    <div class="text-xs text-gray-500 truncate pl-3">${email.snippet}</div>
                `;
                emailItem.addEventListener('click', () => {
                    const clickedEmailId = parseInt(emailItem.dataset.emailId);
                    const clickedEmail = emails.find(e => e.id === clickedEmailId);
                    if (!clickedEmail) return;
                    currentOpenEmail = clickedEmail;
                    displayEmailContent(clickedEmail);
                    if (selectedEmailItem && selectedEmailItem !== emailItem) { selectedEmailItem.classList.remove('selected'); }
                    if (emailItem.classList.contains('unread')) {
                         emailItem.classList.remove('unread');
                         const blueIndicatorDot = emailItem.querySelector('.absolute.left-1');
                         if (blueIndicatorDot) blueIndicatorDot.style.display = 'none';
                         emailItem.querySelectorAll('.font-semibold').forEach(el => el.classList.replace('font-semibold','font-normal'));
                         emailItem.querySelectorAll('.text-gray-900').forEach(el => el.classList.replace('text-gray-900','text-gray-700'));
                         emailItem.querySelectorAll('.text-blue-600').forEach(el => el.classList.replace('text-blue-600','text-gray-500'));
                         clickedEmail.unread = false;
                         updateUnreadCount();
                    }
                    emailItem.classList.add('selected');
                    selectedEmailItem = emailItem;
                    if (isGoFreightMatePanelOpen) {
                        console.log("Panel is open, auto-triggering analysis for new email.");
                        triggerGoFreightMateAnalysis(currentOpenEmail);
                    }
                });
                emailListContainer.appendChild(emailItem);
            });
             updateUnreadCount();
        }

        function displayEmailContent(email) {
            readingPanePlaceholder.classList.add('hidden');
            emailContentArea.classList.remove('hidden');
            emailContentArea.classList.add('flex');
            emailSubject.textContent = email.subject;
            emailSender.textContent = email.sender;
            senderInitial.textContent = email.senderInitial;
            emailTimestamp.textContent = email.timestamp;
            emailBody.innerHTML = email.body;
            if (gofreightmateButton) { gofreightmateButton.classList.remove('hidden'); }
            else { console.error("Cannot show GoFreightMate button - not found!"); }
        }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', (event) => {
            console.log("DOMContentLoaded event fired.");

            // --- Robust Lucide Initialization with Polling ---
            const maxWaitTime = 5000; // Max wait 5 seconds for Lucide
            const checkInterval = 100; // Check every 100ms
            let elapsedTime = 0;

            lucideCheckInterval = setInterval(() => {
                elapsedTime += checkInterval;
                // console.log("Checking for Lucide..."); // Optional: noisy log

                if (typeof lucide !== 'undefined') {
                    console.log("Lucide object found after", elapsedTime, "ms.");
                    clearInterval(lucideCheckInterval); // Stop polling
                    if(lucideCheckTimeout) clearTimeout(lucideCheckTimeout); // Clear timeout timer
                    try {
                        lucide.createIcons();
                        console.log("Lucide icons initialized successfully.");
                    } catch (error) {
                        console.error("Error initializing Lucide icons:", error);
                    }
                } else if (elapsedTime >= maxWaitTime) {
                     console.error("Lucide library failed to load within", maxWaitTime / 1000, "seconds.");
                     clearInterval(lucideCheckInterval); // Stop polling
                     if(lucideCheckTimeout) clearTimeout(lucideCheckTimeout); // Clear timeout timer
                }
            }, checkInterval);

            // Set a timeout to ensure the interval stops even if lucide never loads
            lucideCheckTimeout = setTimeout(() => {
                 if (lucideCheckInterval) { // Check if interval is still running
                     console.error("Lucide check timed out after", maxWaitTime / 1000, "seconds.");
                     clearInterval(lucideCheckInterval);
                 }
            }, maxWaitTime + 50); // Add a small buffer to timeout


            displayEmails(); // Populate email list

            // --- Attach Sidebar Toggle Listener ---
            if (sidebarToggleButton && sidebar) {
                 sidebarToggleButton.addEventListener('click', toggleSidebar);
                 console.log("Sidebar toggle button listener attached.");
            } else {
                 console.error("Sidebar or Sidebar toggle button not found!");
            }
            // --- Attach GoFreightMate Listeners ---
            if (gofreightmateButton) { gofreightmateButton.addEventListener('click', openGoFreightMatePanel); console.log("GoFreightMate button listener attached."); }
            else { console.error("GoFreightMate button not found when attaching listener!"); }
            if (gofreightmateCloseButton) { gofreightmateCloseButton.addEventListener('click', closeGoFreightMatePanel); console.log("GoFreightMate close button listener attached."); }
            else { console.error("GoFreightMate close button not found!"); }

             // Initial state setup
             if (gofreightmateButton) { gofreightmateButton.classList.add('hidden'); }
             if (gofreightmatePanel) { gofreightmatePanel.classList.add('hidden'); gofreightmatePanel.classList.remove('flex'); }

            // Initialize HB/L editing functionality
            const hblEditButton = document.getElementById('hbl-edit-button');
            const hblSaveButton = document.getElementById('hbl-save-button');
            const hblDisplay = document.getElementById('hbl-display');
            const hblEditForm = document.getElementById('hbl-edit-form');
            const hblInput = document.getElementById('hbl-input');

            if (hblEditButton) {
                hblEditButton.addEventListener('click', () => {
                    hblDisplay.classList.add('hidden');
                    hblEditForm.classList.remove('hidden');
                    hblInput.focus();
                    hblInput.select();
                });
            }

            if (hblSaveButton) {
                hblSaveButton.addEventListener('click', () => {
                    const newHblNo = hblInput.value.trim();
                    if (newHblNo !== currentHblNo) {
                        currentHblNo = newHblNo;
                        hblDisplay.textContent = currentHblNo;
                        
                        // If there's an open email, re-trigger analysis
                        if (currentOpenEmail) {
                            showLoadingIndicator();
                            if (analysisTimeoutId) { 
                                clearTimeout(analysisTimeoutId); 
                            }
                            analysisTimeoutId = setTimeout(() => {
                                populateGoFreightMateContent(currentOpenEmail);
                                analysisTimeoutId = null;
                            }, 1000);
                        }
                    }
                    hblEditForm.classList.add('hidden');
                    hblDisplay.classList.remove('hidden');
                });
            }

        });
    </script>
</body>
</html>

