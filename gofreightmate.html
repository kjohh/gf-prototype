<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoFreightMate Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar styles */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }

        /* SVG icon base styles (replace .lucide class) */
        .svg-icon {
            width: 1.1rem;
            height: 1.1rem;
            stroke-width: 2;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
            fill: none; /* Most Lucide icons don't need fill */
            stroke: currentColor; /* Default to text color */
        }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Lucide icon styles */
        .lucide { width: 1.1rem; height: 1.1rem; stroke-width: 2; display: inline-block; vertical-align: middle; margin-right: 0.5rem; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }


        /* Selected email styles */
        .email-item.selected { background-color: #e2e8f0; border-left: 3px solid #2563eb; }

        /* Unread email styles */
        .email-item.unread .font-semibold { font-weight: 700; }
        .email-item.unread .text-gray-900 { color: #111827; }
        .email-item.unread .text-blue-600 { color: #2563eb; }

        /* GoFreightMate panel styles */
        #gofreightmate-panel { z-index: 5; }

        /* GoFreightMate field styles */
        .gfm-field { margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e5e7eb; }
        .gfm-label { font-weight: 600; color: #374151; margin-bottom: 0.25rem; display: block; }
        .gfm-data { font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem; word-wrap: break-word; }
        .gfm-data.ai { color: #1d4ed8; font-weight: 500; }
        .gfm-update input { width: 100%; padding: 0.25rem 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; }
 
        /* New modern card-style field styles */
        .gfm-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
            position: relative;
        }
        .gfm-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .gfm-card-header {
            margin-bottom: 0.75rem;
            border-bottom: 1px solid #f3f4f6;
            padding-bottom: 0.5rem;
        }
        .gfm-card-title {
            font-weight: 600;
            color: #4b5563;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }
        .gfm-card-title i {
            margin-right: 0.5rem;
            color: #6366f1;
        }
        .gfm-card-content {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .gfm-card-row {
            display: flex;
            flex-direction: column;
        }
        .gfm-card-label {
            font-size: 0.7rem;
            color: #6b7280;
            margin-bottom: 0.125rem;
        }
        .gfm-card-value {
            font-size: 0.875rem;
            color: #374151;
            font-weight: 500;
            word-wrap: break-word;
        }
        .gfm-card-value.ai {
            color: #4f46e5;
        }
        .gfm-card-value.current {
            color: #6b7280;
        }
        .gfm-card-input {
            margin-top: 0.5rem;
            width: 100%;
            padding: 0.375rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.15s ease-in-out;
        }
        .gfm-card-input:focus {
            border-color: #6366f1;
            outline: none;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        /* Input type specific styles */
        .gfm-date-picker {
            margin-top: 0.5rem;
            width: 100%;
            padding: 0.375rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.15s ease-in-out;
            background-color: white;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.2rem;
            padding-right: 2rem;
        }
        
        /* 添加禁用輸入欄位的樣式 */
        .gfm-card-input:disabled,
        .gfm-date-picker:disabled,
        .gfm-select:disabled,
        .gfm-autocomplete-input:disabled {
            background-color: #f9fafb;
            color: #6b7280;
            cursor: not-allowed;
            border-color: #e5e7eb;
            opacity: 0.75;
        }
        
        /* 禁用時增加淡色邊框指示更新過的欄位 */
        .gfm-card.updated .gfm-card-input:disabled,
        .gfm-card.updated .gfm-date-picker:disabled,
        .gfm-card.updated .gfm-select:disabled,
        .gfm-card.updated .gfm-autocomplete-input:disabled {
            border-color: #aeaeae;
            background-color: #aeaeae;
        }

        .gfm-select-wrapper {
            margin-top: 0.5rem;
            position: relative;
        }
        .gfm-select {
            width: 100%;
            padding: 0.375rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.15s ease-in-out;
            background-color: white;
            appearance: none;
            padding-right: 2rem;
        }
        .gfm-select:focus {
            border-color: #6366f1;
            outline: none;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
        .gfm-select-arrow {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #6b7280;
        }
        .gfm-autocomplete-wrapper {
            margin-top: 0.5rem;
            position: relative;
        }
        .gfm-autocomplete-input {
            width: 100%;
            padding: 0.375rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.15s ease-in-out;
        }
        .gfm-autocomplete-input:focus {
            border-color: #6366f1;
            outline: none;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
        .gfm-autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 10;
            display: none;
        }
        .gfm-autocomplete-item {
            padding: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .gfm-autocomplete-item:hover {
            background-color: #f3f4f6;
        }
        .gfm-autocomplete-wrapper.active .gfm-autocomplete-dropdown {
            display: block;
        }

        /* HB/L No. card styles */
        .hbl-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
        }
        .hbl-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .hbl-card-title {
            font-weight: 600;
            color: #4b5563;
        }
        .hbl-card-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: #4f46e5;
            margin-top: 0.25rem;
        }
        .hbl-edit-btn {
            border: none;
            background: transparent;
            color: #6366f1;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }
        .hbl-edit-btn:hover {
            background-color: #f3f4f6;
        }
        .hbl-edit-form {
            margin-top: 0.75rem;
        }
        .hbl-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        .hbl-save-btn {
            background-color: #4f46e5;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .hbl-save-btn:hover {
            background-color: #4338ca;
        }

        /* Updated badge style */
        .hbl-updated-badge {
            background-color: #10b981;
            color: white;
            font-size: 0.7rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            margin-left: 0.75rem;
            display: inline-flex;
            align-items: center;
        }
        .hbl-updated-badge i {
            margin-right: 0.25rem;
            width: 0.8rem;
            height: 0.8rem;
        }

        /* Status message styles */
        .status-message {
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            font-size: 0.875rem;
        }
        .status-message i {
            margin-right: 0.5rem;
        }
        .status-message.success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .status-message.error {
            background-color: #fee2e2;
            color: #b91c1c;
            border: 1px solid #fecaca;
        }
        .status-message.hidden {
            display: none;
        }

        /* Button loading state */
        .btn-loading {
            position: relative;
            color: transparent !important;
        }
        .btn-loading::after {
            content: "";
            position: absolute;
            width: 1rem;
            height: 1rem;
            top: calc(50% - 0.5rem);
            left: calc(50% - 0.5rem);
            border: 2px solid white;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }

        /* Collapsible sidebar styles */
        #sidebar {
            transition: width 0.3s ease-in-out; /* Smooth width transition */
        }
        #sidebar.sidebar-collapsed {
            width: 4rem; /* Tailwind w-16 */
        }
         /* Hide collapsible content when sidebar is collapsed */
        #sidebar.sidebar-collapsed #sidebar-collapsible-content {
            display: none;
        }
         /* Hide Outlook text when sidebar is collapsed */
        #sidebar.sidebar-collapsed #outlook-title {
             display: none;
        }
         /* Adjust toggle button margins when sidebar is collapsed */
         #sidebar.sidebar-collapsed #sidebar-toggle-button .lucide {
              margin-right: 0; /* Remove right margin for icon */
         }
         /* Ensure header area padding is appropriate when sidebar is collapsed */
         #sidebar.sidebar-collapsed #sidebar-header {
              padding-left: 1rem; /* Adjust left padding to center icon */
              padding-right: 1rem;
         }

        /* 添加入口頁面卡片樣式 */
        .feature-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .feature-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            border-color: #c7d2fe;
        }
        .feature-card h3 {
            font-weight: 600;
            color: #4f46e5;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        .feature-card p {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        /* 上傳功能樣式 */
        .upload-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }
        .upload-option {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .upload-option:hover {
            background-color: #f5f3ff;
            border-color: #c7d2fe;
        }
        .upload-option.selected {
            background-color: #ede9fe;
            border-color: #a78bfa;
        }
        .upload-option-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .upload-option-header input[type="radio"] {
            margin-right: 0.5rem;
        }
        .upload-option-header label {
            font-weight: 500;
            color: #4b5563;
        }
        .upload-option-desc {
            padding-left: 1.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .attachment-list {
            margin-top: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .attachment-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            background-color: white;
        }
        .attachment-item:last-child {
            border-bottom: none;
        }
        .attachment-icon {
            margin-right: 0.75rem;
            color: #6b7280;
        }
        .attachment-name {
            flex: 1;
            font-size: 0.875rem;
            color: #374151;
        }
        .attachment-size {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-left: 0.5rem;
        }
        
        .back-button {
            display: inline-flex;
            align-items: center;
            background: none;
            border: none;
            color: #6b7280;
            font-size: 0.875rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            transition: background-color 0.2s;
        }
        .back-button:hover {
            background-color: #f3f4f6;
            color: #4b5563;
        }
        .back-button i {
            margin-right: 0.25rem;
        }

        /* No attachment alert */
        .no-attachment-alert {
            background-color: #fee2e2;
            border: 1px solid #fecaca;
            color: #b91c1c;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        .no-attachment-alert i {
            margin-right: 0.5rem;
            flex-shrink: 0;
        }
        
        /* Upload success message */
        .upload-success {
            background-color: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        .upload-success-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .upload-success-header i {
            margin-right: 0.5rem;
        }
        .upload-success-details {
            margin-top: 0.5rem;
            padding-left: 1.5rem;
        }
        .upload-success-details p {
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }
        .shipment-link {
            display: inline-block;
            color: #4f46e5;
            font-weight: 500;
            margin-top: 0.5rem;
            text-decoration: underline;
        }
        
        /* Previously uploaded indicator */
        .previously-uploaded {
            display: flex;
            align-items: center;
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.5rem;
        }
        .previously-uploaded i {
            margin-right: 0.25rem;
            width: 0.875rem;
            height: 0.875rem;
        }

        /* 添加欄位選擇器樣式 */
        .gfm-card-checkbox {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: absolute;
            top: 1rem;
            right: 1rem;
        }

        .gfm-card-checkbox input[type="checkbox"] {
            width: 1.2rem;
            height: 1.2rem;
            cursor: pointer;
            accent-color: #6366f1;
            position: relative;
            top: 1px;
        }

        .gfm-card-checkbox label {
            font-size: 0.75rem;
            color: #6b7280;
            cursor: pointer;
        }

        /* 添加自定義欄位樣式 */
        .add-custom-field {
            margin-top: 1.5rem;
            padding: 1rem;
            border: 1px dashed #d1d5db;
            border-radius: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-custom-field:hover {
            border-color: #6366f1;
            background-color: #f5f3ff;
        }

        .add-custom-field i {
            color: #6366f1;
            margin-bottom: 0.5rem;
        }

        .add-custom-field-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: #4b5563;
            margin-bottom: 0.25rem;
        }

        .add-custom-field-desc {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .custom-field-form {
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 0.75rem;
            margin-top: 1rem;
            display: none;
        }

        .custom-field-form.active {
            display: block;
        }

        .custom-field-form-row {
            margin-bottom: 0.75rem;
        }

        .custom-field-form-row label {
            display: block;
            font-size: 0.75rem;
            color: #4b5563;
            margin-bottom: 0.25rem;
        }

        .custom-field-form-row input,
        .custom-field-form-row select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.15s ease-in-out;
        }

        .custom-field-form-row input:focus,
        .custom-field-form-row select:focus {
            border-color: #6366f1;
            outline: none;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .custom-field-form-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .custom-field-form-buttons button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-cancel {
            background-color: #f3f4f6;
            color: #4b5563;
            border: 1px solid #d1d5db;
        }

        .btn-cancel:hover {
            background-color: #e5e7eb;
        }

        .btn-add {
            background-color: #6366f1;
            color: white;
            border: none;
        }

        .btn-add:hover {
            background-color: #4f46e5;
        }

        /* 覆蓋原有的待更新樣式 */
        .gfm-card.to-update {
            border-left: 3px solid #6366f1;
            background-color: #f5f3ff;
        }

        .gfm-card.not-update {
            opacity: 0.7;
        }

        .update-selection-note {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background-color: #f9fafb;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
        }

        .update-selection-note i {
            margin-right: 0.5rem;
            color: #6366f1;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans flex h-screen overflow-hidden">

    <aside id="sidebar" class="w-64 bg-[#F3F2F1] border-r border-gray-300 flex flex-col flex-shrink-0">
         <div id="sidebar-header" class="p-4 flex items-center space-x-2 border-b border-gray-300 flex-shrink-0">
            <button id="sidebar-toggle-button" class="p-1 hover:bg-gray-200 rounded">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="svg-icon text-gray-600 !mr-0"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
            </button>
            <span id="outlook-title" class="text-lg font-semibold text-gray-800">Outlook</span>
        </div>

        <div id="sidebar-collapsible-content" class="flex flex-col flex-1 overflow-y-auto">
            <div class="p-4">
                <button class="w-full bg-[#0078D4] text-white py-2 px-4 rounded-md shadow hover:bg-[#005A9E] transition duration-150 flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                    <span>New Email</span>
                </button>
            </div>
            <nav class="flex-1 overflow-y-auto p-2 space-y-1">
                <a href="#" class="flex items-center px-3 py-2 text-gray-700 font-medium bg-gray-200 rounded-md">
                    <i data-lucide="inbox"></i> Inbox
                    <span id="inbox-count" class="ml-auto text-xs bg-blue-500 text-white rounded-full px-2 py-0.5">0</span>
                </a>
                <a href="#" class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i data-lucide="file-text"></i> Drafts</a>
                <a href="#" class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i data-lucide="send"></i> Sent Items</a>
                <a href="#" class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i data-lucide="archive"></i> Archive</a>
                <a href="#" class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i data-lucide="trash-2"></i> Deleted Items</a>
                 <a href="#" class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i data-lucide="alert-octagon"></i> Junk Email</a>
                 <div class="pt-4">
                    <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Folders</h3>
                    <a href="#" class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-200 rounded-md mt-1"><i data-lucide="folder"></i> Customs Documents</a>
                     <a href="#" class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i data-lucide="folder"></i> Carrier Notifications</a>
                     <a href="#" class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-200 rounded-md"><i data-lucide="folder"></i> Customer A</a>
                </div>
            </nav>
            <div class="p-3 border-t border-gray-300 flex justify-around flex-shrink-0">
                 <i data-lucide="mail" class="text-gray-600 cursor-pointer hover:text-blue-600"></i>
                 <i data-lucide="calendar" class="text-gray-600 cursor-pointer hover:text-blue-600"></i>
                 <i data-lucide="users" class="text-gray-600 cursor-pointer hover:text-blue-600"></i>
                 <i data-lucide="paperclip" class="text-gray-600 cursor-pointer hover:text-blue-600"></i>
                 <i data-lucide="clipboard-list" class="text-gray-600 cursor-pointer hover:text-blue-600"></i>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex h-screen overflow-hidden">

        <section id="email-list-pane" class="w-96 bg-white border-r border-gray-300 flex flex-col h-full flex-shrink-0">
            <div class="p-4 border-b border-gray-300 flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-800">Inbox</h2>
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-500">Filter</span>
                    <i data-lucide="filter" class="text-gray-600 cursor-pointer hover:text-blue-600"></i>
                </div>
            </div>
            <div id="email-list" class="overflow-y-auto flex-1">
                </div>
        </section>

        <section id="reading-pane" class="flex-1 bg-white flex flex-col h-full overflow-y-auto border-r border-gray-300">
            <div id="reading-pane-placeholder" class="flex-1 flex items-center justify-center text-gray-500">
                Select an item to read
            </div>
            <div id="email-content-area" class="hidden flex-1 flex flex-col">
                <div class="p-4 border-b border-gray-300">
                    <h3 id="email-subject" class="text-xl font-semibold text-gray-800 mb-2"></h3>
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-xl flex-shrink-0" id="sender-initial"></div>
                        <div>
                            <div id="email-sender" class="font-medium text-gray-900"></div>
                            <div class="text-sm text-gray-500">To: <span id="email-recipient">You</span></div>
                        </div>
                        <div class="ml-auto text-sm text-gray-500 flex-shrink-0" id="email-timestamp"></div>
                    </div>
                     <div class="flex space-x-2 text-gray-600">
                        <button class="p-1 hover:bg-gray-200 rounded flex items-center space-x-1"><i data-lucide="reply"></i> <span>Reply</span></button>
                        <button class="p-1 hover:bg-gray-200 rounded flex items-center space-x-1"><i data-lucide="reply-all"></i> <span>Reply All</span></button>
                        <button class="p-1 hover:bg-gray-200 rounded flex items-center space-x-1"><i data-lucide="forward"></i> <span>Forward</span></button>
                        <button id="gofreightmate-button" class="ml-4 p-1 bg-purple-600 text-white rounded hover:bg-purple-700 flex items-center space-x-1">
                            <i data-lucide="scan-line"></i> <span>GoFreightMate</span>
                        </button>
                        <button class="ml-auto p-1 hover:bg-gray-200 rounded"><i data-lucide="archive"></i></button>
                        <button class="p-1 hover:bg-gray-200 rounded"><i data-lucide="trash-2"></i></button>
                        <button class="p-1 hover:bg-gray-200 rounded"><i data-lucide="ellipsis"></i></button>
                    </div>
                </div>
                <div id="email-body" class="p-6 flex-1 overflow-y-auto text-gray-800 leading-relaxed">
                    <!-- 郵件正文將在這裡動態添加 -->
                    <div id="email-content"></div>
                    
                    <!-- 郵件附件部分 -->
                    <div id="email-attachments" class="mt-6 pt-4 border-t border-gray-200">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Attachments</h4>
                        <div class="email-attachment-list flex flex-col gap-2">
                            <!-- 附件項目將在這裡動態添加 -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

         <aside id="gofreightmate-panel" class="w-96 h-full bg-gray-50 border-l-2 border-purple-200 shadow-lg p-4 flex-col overflow-y-auto flex-shrink-0 hidden"> 
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-purple-200 flex-shrink-0">
                <h3 class="text-lg font-semibold text-purple-800 flex items-center">
                    <i data-lucide="scan-line" class="text-purple-600"></i> GoFreightMate AI</h3>
                <button id="gofreightmate-close-button" class="p-1 text-purple-500 hover:text-purple-700 hover:bg-purple-100 rounded">
                    <i data-lucide="x"></i>
                </button>
            </div>
            
            <!-- 入口頁面 -->
            <div id="gfm-home-page" class="flex-1">
                <div class="mb-6">
                    <h2 class="text-xl font-bold text-purple-900 mb-2">Smart Email Assistant</h2>
                    <p class="text-gray-600 text-sm">GoFreightMate AI helps you extract information from emails and integrate with GoFreight system to improve efficiency.</p>
                </div>
                
                <div class="feature-card" id="data-extraction-card">
                    <h3>Data Scanning</h3>
                    <p>Automatically identify and extract shipping-related data from emails, easily update records in GoFreight system.</p>
                </div>
                
                <div class="feature-card" id="file-upload-card">
                    <h3>Upload Email & Attachments</h3>
                    <p>Easily upload the entire email or email attachments to the corresponding Shipment record in GoFreight system.</p>
                </div>
                
                <div class="mt-6 text-xs text-gray-500">
                    <p>Tip: Click on a feature card to continue. When switching emails, GoFreightMate will maintain the current feature page.</p>
                </div>
            </div>
            
            <!-- 數據掃描頁面 -->
            <div id="gfm-data-extraction-page" class="flex-1 hidden">
                <button class="back-button">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i> Back
                </button>
                
                <div id="hbl-section" class="hidden">
                    <div class="hbl-card">
                        <div class="hbl-card-header">
                            <div class="hbl-card-title">
                                HB/L No.
                                <span id="hbl-updated-badge" class="hbl-updated-badge hidden">
                                    <i data-lucide="check-circle"></i> Updated
                                </span>
                            </div>
                            <button id="hbl-edit-button" class="hbl-edit-btn">
                                <i data-lucide="edit-3" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div id="hbl-display" class="hbl-card-value">EGLV1234567890</div>
                        <div id="hbl-edit-form" class="hbl-edit-form hidden">
                            <input type="text" id="hbl-input" class="hbl-input" value="EGLV1234567890">
                            <button id="hbl-save-button" class="hbl-save-btn">Confirm</button>
                        </div>
                    </div>
                    
                    <!-- 欄位勾選提示 -->
                    <div class="update-selection-note mb-4">
                        <i data-lucide="info"></i>
                        <span>勾選要更新的欄位，取消勾選表示不更新該欄位。</span>
                    </div>
                </div>
                
                <div id="gofreightmate-content" class="flex-1">
                    <p class="text-center text-purple-600">Click the GoFreightMate button to start analysis.</p>
                </div>
                
                <!-- 添加自定義欄位區域 -->
                <div id="custom-field-container" class="hidden mt-4">
                    <!-- 添加自定義欄位按鈕 -->
                    <div class="add-custom-field" id="add-custom-field-btn">
                        <i data-lucide="plus-circle" class="w-6 h-6 mx-auto"></i>
                        <div class="add-custom-field-title">新增自定義欄位</div>
                        <div class="add-custom-field-desc">新增 GoFreight 中沒有的欄位資料</div>
                    </div>
                    
                    <!-- 自定義欄位表單 -->
                    <div class="custom-field-form" id="custom-field-form">
                        <div class="custom-field-form-row">
                            <label for="custom-field-name">欄位名稱</label>
                            <div class="gfm-autocomplete-wrapper">
                                <input type="text" id="custom-field-name" class="gfm-autocomplete-input" placeholder="開始輸入欄位名稱...">
                                <div class="gfm-autocomplete-dropdown">
                                    <div class="gfm-autocomplete-item">Shipper</div>
                                    <div class="gfm-autocomplete-item">Consignee</div>
                                    <div class="gfm-autocomplete-item">Customer</div>
                                    <div class="gfm-autocomplete-item">Notify</div>
                                    <div class="gfm-autocomplete-item">ETD</div>
                                    <div class="gfm-autocomplete-item">ETA</div>
                                    <div class="gfm-autocomplete-item">CY/CFS Location</div>
                                    <div class="gfm-autocomplete-item">Incoterm</div>
                                </div>
                            </div>
                        </div>
                        <div class="custom-field-form-row">
                            <label for="custom-field-value">欄位值</label>
                            <input type="text" id="custom-field-value" placeholder="輸入欄位值">
                        </div>
                        <div class="custom-field-form-buttons">
                            <button class="btn-cancel" id="cancel-custom-field">取消</button>
                            <button class="btn-add" id="confirm-custom-field">新增</button>
                        </div>
                    </div>
                    
                    <!-- 已添加的自定義欄位將在這裡顯示 -->
                    <div id="added-custom-fields"></div>
                </div>
            </div>
            
            <!-- 上傳郵件和附件頁面 -->
            <div id="gfm-upload-page" class="flex-1 hidden">
                <button class="back-button">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i> Back
                </button>
                
                <div class="mb-6">
                    <h2 class="text-lg font-semibold text-purple-800 mb-3">Upload Email & Attachments</h2>
                    
                    <div class="hbl-card">
                        <div class="hbl-card-header">
                            <div class="hbl-card-title">
                                MB/L No.
                            </div>
                            <button id="mbl-edit-button" class="hbl-edit-btn">
                                <i data-lucide="edit-3" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div id="mbl-display" class="hbl-card-value">KIOR294757356</div>
                        <div id="mbl-edit-form" class="hbl-edit-form hidden">
                            <input type="text" id="mbl-input" class="hbl-input" value="KIOR294757356">
                            <button id="mbl-save-button" class="hbl-save-btn">Confirm</button>
                        </div>
                        <div class="previously-uploaded hidden" id="previously-uploaded-indicator">
                            <i data-lucide="info" class="text-gray-500"></i>
                            <span>Attachments previously uploaded on 2024-04-15 15:30</span>
                        </div>
                    </div>
                    
                    <div class="upload-options mt-4">
                        <div class="upload-option" data-option="full">
                            <div class="upload-option-header">
                                <input type="radio" id="upload-full" name="upload-type" checked>
                                <label for="upload-full">Upload Email & Attachments</label>
                            </div>
                            <div class="upload-option-desc">
                                Upload the entire email content and all attachments to GoFreight
                            </div>
                        </div>
                        
                        <div class="upload-option" data-option="attachment-only">
                            <div class="upload-option-header">
                                <input type="radio" id="upload-attachment" name="upload-type">
                                <label for="upload-attachment">Upload Attachments Only</label>
                            </div>
                            <div class="upload-option-desc">
                                Only upload the attachments from the email to GoFreight
                            </div>
                        </div>
                    </div>
                    
                    <div class="attachment-list mt-4" id="attachment-list">
                        <div class="attachment-item">
                            <div class="attachment-icon">
                                <i data-lucide="file-text" class="w-5 h-5"></i>
                            </div>
                            <div class="attachment-name">Invoice_KIOR294757356.pdf</div>
                            <div class="attachment-size">215 KB</div>
                        </div>
                        <div class="attachment-item">
                            <div class="attachment-icon">
                                <i data-lucide="file-text" class="w-5 h-5"></i>
                            </div>
                            <div class="attachment-name">Packing_List_KIOR294757356.pdf</div>
                            <div class="attachment-size">187 KB</div>
                        </div>
                    </div>
                    
                    <div class="no-attachment-alert hidden" id="no-attachment-alert">
                        <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                        <div>
                            <p class="font-medium">No attachments to upload</p>
                            <p class="text-sm">There are no attachments in this email that can be uploaded.</p>
                        </div>
                    </div>
                    
                    <div class="upload-success hidden" id="upload-success">
                        <div class="upload-success-header">
                            <i data-lucide="check-circle" class="w-5 h-5"></i>
                            <span>Upload Successful</span>
                        </div>
                        <div class="upload-success-details">
                            <p><strong>MB/L No.:</strong> <span id="success-mbl-no">KIOR294757356</span></p>
                            <p><strong>Uploaded Content:</strong> <span id="success-content-type">Email & Attachments (2 files)</span></p>
                            <p><strong>Upload Time:</strong> <span id="success-time">2024-04-16 11:42</span></p>
                            <a href="#" class="shipment-link">Go to GoFreight to view Shipment</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-auto pt-4 border-t border-purple-200 flex-shrink-0">
                <div id="status-message" class="status-message hidden mb-3"></div>
                <button id="update-gofreight-btn" class="w-full bg-purple-600 text-white py-2 px-4 rounded-md shadow hover:bg-purple-700 transition duration-150 flex items-center justify-center space-x-2">
                     <i data-lucide="save"></i>
                     <span>Update GoFreight (Simulation)</span>
                </button>
                <button id="upload-btn" class="w-full bg-purple-600 text-white py-2 px-4 rounded-md shadow hover:bg-purple-700 transition duration-150 flex items-center justify-center space-x-2 hidden">
                     <i data-lucide="upload"></i>
                     <span>Upload</span>
                </button>
            </div>
        </aside>
    </main>

    <!-- Lucide圖標庫 -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js" crossorigin="anonymous"></script>
    <script>
        // Simulated email data for ocean import operator
        const emails = [
            // 1. 可以分析並能成功更新的信件 - 測試場景：ETA 更新信，可成功分析和更新
            { id: 1, sender: 'Maersk Line [TEST: 可分析並成功更新]', senderInitial: 'M', subject: 'ETA Update - Vessel MAERSK HONG KONG V.2401 - Container MSKU1234567', snippet: 'Please note that the updated ETA for MAERSK HONG KONG V.2401 at Los Angeles port is now...', timestamp: '9:45 AM', unread: true, body: `<p>Dear Customer,</p><p>Please be advised that the vessel <strong>MAERSK HONG KONG V.2401</strong> has an updated estimated time of arrival (ETA) at Los Angeles Port (USLAX) of <strong>April 18, 2025, 14:00 PST</strong>.</p><p>Container Number: <strong>MSKU1234567</strong></p><p>Booking Reference: <strong>AE123987</strong></p><p>We apologize for any inconvenience this schedule change may cause. You can track the latest status of the vessel on our website.</p><p>Best regards,<br>Maersk Customer Service</p>`, 
              attachments: [
                { name: 'ETA_Update_MSKU1234567.pdf', size: '156 KB', type: 'pdf' },
                { name: 'Delivery_Instructions.pdf', size: '245 KB', type: 'pdf' }
              ] 
            },
            
            // 2. 可以分析但不能成功更新的信件 - 測試場景：到達通知，可分析但更新會失敗
            { id: 2, sender: 'Evergreen Shipping Agency [TEST: 可分析但更新失敗]', senderInitial: 'E', subject: 'Arrival Notice - EVER ACE V.015E - B/L No. EGLV1234567890', snippet: 'Your cargo on EVER ACE V.015E is scheduled to discharge on April 17. Please arrange...', timestamp: 'Yesterday', unread: true, body: `<p><strong>Arrival Notice</strong></p><p>Dear Customer,</p><p>This is to inform you that your cargo under Bill of Lading <strong>EGLV1234567890</strong> is expected to arrive at Taipei Port (TW TPE) on the vessel <strong>EVER ACE V.015E</strong>.</p><ul><li>Estimated Discharge Date: April 17, 2025</li><li>Container Number: EISU9876543</li><li>Last Free Day: April 21, 2025</li></ul><p>Please ensure timely arrangements for customs clearance and cargo collection to avoid potential demurrage charges.</p><p>Required release documents are attached.</p><p>Sincerely,<br>Evergreen Shipping Agency (America) Inc.</p>`,
              attachments: [
                { name: 'Arrival_Notice_EGLV1234567890.pdf', size: '189 KB', type: 'pdf' },
                { name: 'Customs_Clearance_Form.pdf', size: '134 KB', type: 'pdf' }
              ]
            },
            
            // 3. 可以分析的海關檢查通知 - 測試場景：海關檢查通知，可分析並成功更新
            { id: 3, sender: 'US Customs and Border Protection [TEST: 海關通知，可分析並更新]', senderInitial: 'C', subject: 'URGENT: Examination Notice for Shipment CB552789 - Entry# 235-98754611', snippet: 'Your shipment CB552789 has been selected for examination. Please arrange for the following...', timestamp: 'Yesterday', unread: false, body: `<p>FORMAL NOTICE OF EXAMINATION</p><p>Dear Freight Forwarder,</p><p>US Customs and Border Protection (CBP) has selected the following shipment for examination:</p><ul><li>Entry Number: <strong>235-98754611</strong></li><li>Container Number: <strong>MSDU4456789</strong></li><li>Bill of Lading: <strong>MEDU0098765432</strong></li><li>Vessel/Voyage: MSC ANTONIA / 445E</li><li>Port of Entry: Los Angeles/Long Beach</li><li>Current Location: CES Facility LAX</li></ul><p>The examination has been scheduled for April 18, 2025. Please have a representative available to facilitate the inspection process. All documentation must be submitted electronically through the CBP portal by April 16, 2025.</p><p>For further assistance, please contact the Examination Coordination Center.</p><p>Regards,<br>Customs Examination Team<br>US Customs and Border Protection</p>`,
              attachments: [
                { name: 'CBP_Examination_Notice.pdf', size: '167 KB', type: 'pdf' },
                { name: 'Required_Documents.pdf', size: '210 KB', type: 'pdf' }
              ]
            },
            
            // 4. 可以分析的空櫃通知 - 測試場景：空櫃通知，可分析並成功更新
            { id: 4, sender: 'ONE Line [TEST: 空櫃通知，可分析並更新]', senderInitial: 'O', subject: 'Empty Container Return Instructions - ONEHAN220500123', snippet: 'Please find return instructions for empty containers from shipment ONEHAN220500123...', timestamp: 'Apr 14', unread: false, body: `<p><strong>Empty Container Return Notice</strong></p><p>Dear Valued Customer,</p><p>Please note the return instructions for the following empty containers:</p><ul><li>Booking Reference: <strong>ONEHAN220500123</strong></li><li>Bill of Lading: <strong>ONEA12354697</strong></li><li>Container Numbers: <strong>ONEY6754321, ONEY9988765</strong></li><li>Last Free Day: April 20, 2025</li><li>Return Location: ONE Terminal Oakland (2500 7th Street, Oakland, CA 94607)</li></ul><p>Operating Hours: Mon-Fri 08:00-16:30</p><p>Please ensure all containers are clean and free of debris, labels, and hazardous material residue. Any containers returned in unsatisfactory condition will be subject to cleaning fees.</p><p>Best regards,<br>Equipment Management Department<br>Ocean Network Express (ONE)</p>`,
              attachments: [
                { name: 'Empty_Container_Return.pdf', size: '142 KB', type: 'pdf' },
                { name: 'Terminal_Map.pdf', size: '325 KB', type: 'pdf' }
              ]
            },
            
            // 5. 普通辦公室郵件 - 測試場景：IT部門的通知，無運輸數據，不可分析，有附件可上傳
            { id: 5, sender: 'IT Department [TEST: 非運輸郵件，不可分析但可上傳]', senderInitial: 'I', subject: 'Scheduled System Maintenance - April 16', snippet: 'Please be advised that our systems will be undergoing scheduled maintenance on April 16...', timestamp: 'Apr 14', unread: true, body: `<p>Dear Colleagues,</p><p>Please be advised that our IT systems will be undergoing scheduled maintenance this weekend:</p><ul><li><strong>Date:</strong> Saturday, April 16, 2025</li><li><strong>Time:</strong> 22:00 - 02:00 (GMT-7)</li><li><strong>Affected Systems:</strong> Email server, VPN connections, and document management system</li></ul><p>During this time, you may experience intermittent connectivity issues or service disruptions. Please ensure you save all important work before the maintenance window begins.</p><p>If you have any urgent tasks that require system access during this time, please contact the IT helpdesk to discuss alternative arrangements.</p><p>We apologize for any inconvenience this may cause and appreciate your understanding.</p><p>Best regards,<br>IT Support Team</p>`,
              attachments: [
                { name: 'System_Maintenance_Schedule.pdf', size: '135 KB', type: 'pdf' },
                { name: 'IT_Contact_List.xlsx', size: '95 KB', type: 'excel' }
              ]
            },
            
            // 6. 普通辦公室郵件 - 測試場景：客戶詢問，無運輸數據，不可分析，有附件可上傳
            { id: 6, sender: 'Global Electronics Inc. [TEST: 客戶詢問，不可分析但有多附件]', senderInitial: 'G', subject: 'Quote Request for Monthly Shipments from Shenzhen to Chicago', snippet: 'We are looking for a freight forwarder to handle our monthly shipments from Shenzhen to Chicago...', timestamp: 'Apr 13', unread: false, body: `<p>Dear Freight Services Team,</p><p>Our company, Global Electronics Inc., is seeking quotations for regular monthly shipments from our manufacturing facility in Shenzhen, China to our distribution center in Chicago, IL.</p><p><strong>Shipment Details:</strong></p><ul><li>Product: Consumer electronics (non-hazardous)</li><li>Volume: 2 x 40'HC containers per month</li><li>Schedule: First shipment needed by mid-May</li><li>Special Requirements: Cargo insurance, customs clearance</li><li>Incoterms: FOB Shenzhen</li></ul><p>We are currently evaluating several logistics providers and would appreciate receiving your best rates and transit times for both ocean and air options.</p><p>Could you also provide information about your tracking capabilities and customer service standards?</p><p>Thank you for your assistance. We look forward to your response.</p><p>Best regards,<br>Sarah Johnson<br>Logistics Manager<br>Global Electronics Inc.</p>`,
              attachments: [
                { name: 'Shipping_Requirements.pdf', size: '205 KB', type: 'pdf' },
                { name: 'Company_Profile.pdf', size: '350 KB', type: 'pdf' },
                { name: 'Product_Specifications.xlsx', size: '128 KB', type: 'excel' }
              ]
            },
            
            // 7. 普通辦公室郵件 - 測試場景：人力資源部門通知，無運輸數據，不可分析
            { id: 7, sender: 'HR Department [TEST: HR通知，不可分析]', senderInitial: 'H', subject: 'Reminder: Quarterly Performance Reviews Due April 20', snippet: 'This is a reminder that all Q1 performance reviews must be completed by April 20...', timestamp: 'Apr 12', unread: true, body: `<p>Dear Team Managers,</p><p>This is a friendly reminder that all Q1 2025 performance reviews must be completed and submitted by <strong>April 20, 2025</strong>.</p><p>Please ensure you:</p><ul><li>Schedule review meetings with all team members</li><li>Complete the standardized evaluation form</li><li>Submit signed forms to the HR portal</li><li>Provide copies to your team members</li></ul><p>To access the performance review forms, please visit the HR portal at [intranet link].</p><p>If you need assistance with the review process or have questions about the forms, please contact the HR team by email or at extension 4455.</p><p>Thank you for your cooperation in completing this important process on time.</p><p>Best regards,<br>Human Resources Department</p>`,
              attachments: [
                { name: 'Performance_Review_Form.docx', size: '87 KB', type: 'word' },
                { name: 'Q1_Review_Guidelines.pdf', size: '145 KB', type: 'pdf' }
              ]
            },
            
            // 8. 可以分析的日程邀請 - 測試場景：運營經理的會議通知，部分可分析
            { id: 8, sender: 'Operations Manager [TEST: 會議通知，可部分分析]', senderInitial: 'O', subject: 'Import Shipment Review - ONE OPAL V.236E - Containers NYKU7654321, NYKU7654322', snippet: 'Meeting to review status of critical import shipment arriving on ONE OPAL V.236E...', timestamp: '8:30 AM', unread: true, body: `<p>Hi Team,</p><p>I'd like to schedule a meeting to review the status of the following critical import shipment:</p><ul><li><strong>Vessel:</strong> ONE OPAL V.236E</li><li><strong>ETA:</strong> April 19, 2025</li><li><strong>Containers:</strong> NYKU7654321, NYKU7654322</li><li><strong>Bill of Lading:</strong> ONEABC123456</li><li><strong>Customer:</strong> Premium Electronics Inc.</li></ul><p>We need to ensure all documentation is in order and customs clearance is prepared ahead of arrival. This is a high-priority customer and we need to ensure a smooth delivery process.</p><p><strong>Meeting Details:</strong></p><p>Date: Tomorrow, April 16, 2025<br>Time: 10:00 AM - 10:30 AM<br>Location: Conference Room B / Zoom Link: [Meeting Link]</p><p>Please come prepared with updates on documentation status, customs clearance preparations, and last mile delivery arrangements.</p><p>Thanks,<br>Operations Manager</p>`,
              attachments: [
                { name: 'Shipment_Details_ONEABC123456.pdf', size: '178 KB', type: 'pdf' },
                { name: 'Meeting_Agenda.docx', size: '65 KB', type: 'word' },
                { name: 'Delivery_Timeline.xlsx', size: '120 KB', type: 'excel' }
              ]
            }
        ];

        // DOM Element References
        const sidebar = document.getElementById('sidebar');
        const sidebarToggleButton = document.getElementById('sidebar-toggle-button');
        const emailListContainer = document.getElementById('email-list');
        const readingPanePlaceholder = document.getElementById('reading-pane-placeholder');
        const emailContentArea = document.getElementById('email-content-area');
        const emailSubject = document.getElementById('email-subject');
        const emailSender = document.getElementById('email-sender');
        const senderInitial = document.getElementById('sender-initial');
        const emailRecipient = document.getElementById('email-recipient');
        const emailTimestamp = document.getElementById('email-timestamp');
        const emailBody = document.getElementById('email-body');
        const emailContent = document.getElementById('email-content'); // 添加對郵件正文區域的引用
        const inboxCountSpan = document.getElementById('inbox-count');
        const gofreightmateButton = document.getElementById('gofreightmate-button');
        const gofreightmatePanel = document.getElementById('gofreightmate-panel');
        const gofreightmateContent = document.getElementById('gofreightmate-content');
        const gofreightmateCloseButton = document.getElementById('gofreightmate-close-button');

        let selectedEmailItem = null;
        let currentOpenEmail = null;
        let isGoFreightMatePanelOpen = false;
        let analysisTimeoutId = null;
        let lucideCheckInterval = null; // Interval timer for Lucide check
        let lucideCheckTimeout = null; // Timeout for Lucide check
        let currentHblNo = "EGLV1234567890"; // Added: current HB/L No.
        let currentMblNo = "KIOR294757356"; // Added: current MB/L No.
        let updatedEmailIds = new Set(); // 追踪哪些 email 已經更新過
        let uploadedEmailIds = new Set(); // 追踪哪些 email 已經上傳過附件
        let currentGfmPage = "home"; // 當前GoFreightMate頁面: home, data-extraction, upload

        // --- Helper Functions ---
        function updateUnreadCount() {
            const unreadCount = emails.filter(email => email.unread).length;
            inboxCountSpan.textContent = unreadCount > 0 ? unreadCount : '';
        }

        function showLoadingIndicator() {
             if (!gofreightmatePanel || !gofreightmateContent) return;
             // Hide HBL section
             const hblSection = document.getElementById('hbl-section');
             if (hblSection) {
                 hblSection.classList.add('hidden');
             }
             
             // 隱藏自定義欄位區域
             const customFieldContainer = document.getElementById('custom-field-container');
             if (customFieldContainer) {
                 customFieldContainer.classList.add('hidden');
             }
             
             gofreightmateContent.innerHTML = `
                <div class="flex justify-center items-center h-full">
                    <p class="text-center text-purple-600 flex items-center">
                        <i data-lucide="loader-2" class="animate-spin mr-2"></i> Analyzing...
                    </p>
                </div>`;
             // Ensure icon is rendered immediately after adding HTML
             // Check if lucide is available before calling
             if (typeof lucide !== 'undefined') {
                 try {
                    lucide.createIcons();
                 } catch (error) {
                     console.error("Error creating dynamic Lucide icon (loader):", error);
                 }
             } else {
                 console.error("Lucide not available when showing loading indicator.");
             }
        }

        // 添加上傳頁面的讀取指示器
        function showUploadLoadingIndicator() {
            if (!gofreightmatePanel) return;
            
            // 獲取上傳頁面元素
            const uploadPage = document.getElementById('gfm-upload-page');
            if (!uploadPage) return;
            
            // 確保上傳頁面可見
            uploadPage.classList.remove('hidden');
            
            // 獲取頁面中需要臨時隱藏的元素
            const mblCard = uploadPage.querySelector('.hbl-card');
            const uploadOptions = uploadPage.querySelector('.upload-options');
            const attachmentList = document.getElementById('attachment-list');
            const uploadBtn = document.getElementById('upload-btn');
            
            // 臨時隱藏這些元素
            if (mblCard) mblCard.style.opacity = '0.5';
            if (uploadOptions) uploadOptions.style.opacity = '0.5';
            if (attachmentList) attachmentList.style.opacity = '0.5';
            if (uploadBtn) uploadBtn.classList.add('hidden');
            
            // 添加讀取指示器
            const loadingIndicator = document.createElement('div');
            loadingIndicator.id = 'upload-loading-indicator';
            loadingIndicator.classList.add('flex', 'justify-center', 'items-center', 'my-4');
            loadingIndicator.innerHTML = `
                <p class="text-center text-purple-600 flex items-center">
                    <i data-lucide="loader-2" class="animate-spin mr-2"></i> Loading attachment information...
                </p>
            `;
            
            // 將讀取指示器添加到頁面
            uploadPage.insertBefore(loadingIndicator, uploadOptions);
            
            // 確保圖標被渲染
            if (typeof lucide !== 'undefined') {
                try {
                    lucide.createIcons();
                } catch (error) {
                    console.error("Error creating upload loading icons:", error);
                }
            }
        }

        // 移除上傳頁面的讀取指示器
        function removeUploadLoadingIndicator() {
            const loadingIndicator = document.getElementById('upload-loading-indicator');
            if (loadingIndicator) {
                loadingIndicator.remove();
            }
            
            // 恢復頁面元素的可見性
            const uploadPage = document.getElementById('gfm-upload-page');
            if (!uploadPage) return;
            
            const mblCard = uploadPage.querySelector('.hbl-card');
            const uploadOptions = uploadPage.querySelector('.upload-options');
            const attachmentList = document.getElementById('attachment-list');
            const uploadBtn = document.getElementById('upload-btn');
            const noAttachmentAlert = document.getElementById('no-attachment-alert');
            
            if (mblCard) mblCard.style.opacity = '1';
            if (uploadOptions) uploadOptions.style.opacity = '1';
            if (attachmentList) attachmentList.style.opacity = '1';
            
            // 根據當前郵件是否已上傳決定顯示上傳按鈕
            if (uploadBtn && currentOpenEmail && !uploadedEmailIds.has(currentOpenEmail.id)) {
                uploadBtn.classList.remove('hidden');
                uploadBtn.style.display = 'flex';
            }
        }

        // --- Sidebar Toggle Function ---
        function toggleSidebar() {
            if (sidebar) {
                sidebar.classList.toggle('sidebar-collapsed');
                console.log("Sidebar toggled. Collapsed state:", sidebar.classList.contains('sidebar-collapsed'));
            } else {
                console.error("Sidebar element not found for toggling.");
            }
        }

        // --- GoFreightMate Functions ---
        function triggerGoFreightMateAnalysis(email) {
            if (!email) return;
            console.log("Triggering analysis for email ID:", email.id);
            if (analysisTimeoutId) { clearTimeout(analysisTimeoutId); analysisTimeoutId = null; }
            showLoadingIndicator();
            analysisTimeoutId = setTimeout(() => {
                populateGoFreightMateContent(email);
                analysisTimeoutId = null;
            }, 1000);
        }

        // 處理欄位選擇更新狀態
        function handleFieldSelectionToggle() {
            document.querySelectorAll('.field-update-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    // 取得當前 checkbox 所屬的卡片
                    const card = this.closest('.gfm-card');
                    
                    if (this.checked) {
                        // 選中時添加更新樣式
                        card.classList.add('to-update');
                        card.classList.remove('not-update');
                    } else {
                        // 未選中時添加非更新樣式
                        card.classList.remove('to-update');
                        card.classList.add('not-update');
                    }
                });
                
                // 初始化所有卡片為選中狀態
                const card = checkbox.closest('.gfm-card');
                card.classList.add('to-update');
            });
        }
        
        // 處理自定義欄位添加
        function setupCustomFieldFunctionality() {
            const addCustomFieldBtn = document.getElementById('add-custom-field-btn');
            const customFieldForm = document.getElementById('custom-field-form');
            const cancelCustomFieldBtn = document.getElementById('cancel-custom-field');
            const confirmCustomFieldBtn = document.getElementById('confirm-custom-field');
            const addedCustomFieldsContainer = document.getElementById('added-custom-fields');
            
            // 確保元素存在
            if (!addCustomFieldBtn || !customFieldForm || !cancelCustomFieldBtn || !confirmCustomFieldBtn || !addedCustomFieldsContainer) {
                console.error("自定義欄位相關元素缺失");
                return;
            }
            
            // 顯示自定義欄位表單
            addCustomFieldBtn.addEventListener('click', function() {
                customFieldForm.classList.add('active');
                // 清空表單
                document.getElementById('custom-field-name').value = '';
                document.getElementById('custom-field-type').value = 'text';
                document.getElementById('custom-field-value').value = '';
            });
            
            // 取消添加
            cancelCustomFieldBtn.addEventListener('click', function() {
                customFieldForm.classList.remove('active');
            });
            
            // 確認添加
            confirmCustomFieldBtn.addEventListener('click', function() {
                const fieldName = document.getElementById('custom-field-name').value.trim();
                const fieldValue = document.getElementById('custom-field-value').value.trim();
                
                // 驗證必填欄位
                if (!fieldName || !fieldValue) {
                    alert('請填寫欄位名稱和值');
                    return;
                }
                
                // 創建自定義欄位
                addCustomField(fieldName, fieldValue);
                
                // 隱藏表單
                customFieldForm.classList.remove('active');
            });
        }
        
        // 添加自定義欄位
        function addCustomField(fieldName, fieldValue) {
            const addedCustomFieldsContainer = document.getElementById('added-custom-fields');
            
            // 生成唯一ID
            const fieldId = 'custom-' + Date.now();
            
            // 創建自定義欄位卡片
            const customFieldHtml = `
                <div class="gfm-card to-update" data-field-label="${fieldName}" data-custom="true">
                    <div class="gfm-card-header">
                        <div class="gfm-card-title">
                            <i data-lucide="clipboard-list" class="w-4 h-4"></i>
                            ${fieldName} <span class="text-xs text-purple-500">(自定義)</span>
                        </div>
                        <div class="gfm-card-checkbox" title="勾選此欄位以更新至GoFreight">
                            <input type="checkbox" id="${fieldId}" class="field-update-checkbox" checked>
                            <label for="${fieldId}" class="sr-only">更新此欄位</label>
                        </div>
                    </div>
                    <button class="delete-custom-field absolute top-1 right-8" data-field-id="${fieldId}" title="刪除此欄位">
                        <i data-lucide="trash-2" class="w-4 h-4 text-gray-500 hover:text-red-500"></i>
                    </button>
                    <div class="gfm-card-content">
                        <div class="gfm-card-row">
                            <div class="gfm-card-label">GoFreight Current Data:</div>
                            <div class="gfm-card-value current"><i>(None)</i></div>
                        </div>
                        <div class="gfm-card-row">
                            <div class="gfm-card-label">Update Data:</div>
                            <input type="text" class="gfm-card-input" value="${fieldValue}">
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到容器中
            addedCustomFieldsContainer.insertAdjacentHTML('beforeend', customFieldHtml);
            
            // 初始化刪除功能
            initDeleteCustomField();
            
            // 確保新添加的欄位選擇功能也被初始化
            handleFieldSelectionToggle();
            
            // 確保圖標被渲染
            if (typeof lucide !== 'undefined') {
                try {
                    lucide.createIcons();
                } catch (error) {
                    console.error("Error creating icons for custom field:", error);
                }
            }
        }
        
        // 初始化刪除自定義欄位功能
        function initDeleteCustomField() {
            document.querySelectorAll('.delete-custom-field').forEach(button => {
                // 移除之前添加的事件監聽器（避免重複）
                button.removeEventListener('click', handleDeleteCustomField);
                
                // 添加新的事件監聽器
                button.addEventListener('click', handleDeleteCustomField);
            });
        }
        
        // 處理刪除自定義欄位
        function handleDeleteCustomField(event) {
            const button = event.currentTarget;
            const card = button.closest('.gfm-card');
            if (card) {
                // 詢問用戶確認
                if (confirm('確定要刪除此自定義欄位嗎？')) {
                    card.remove();
                }
            }
        }
        
        // 獲取選中的欄位ID
        function getSelectedFieldIds() {
            const selectedIds = [];
            document.querySelectorAll('.field-update-checkbox:checked').forEach(checkbox => {
                const card = checkbox.closest('.gfm-card');
                const fieldLabel = card.getAttribute('data-field-label');
                selectedIds.push(fieldLabel);
            });
            return selectedIds;
        }

        function openGoFreightMatePanel() {
            console.log("GoFreightMate button clicked!");
            if (!currentOpenEmail) { console.error("Cannot open GoFreightMate: currentOpenEmail is null."); return; }
            isGoFreightMatePanelOpen = true;
            gofreightmatePanel.classList.remove('hidden');
            gofreightmatePanel.classList.add('flex');
            console.log("Panel should be visible now.");
            
            // 顯示入口頁面
            showGfmPage('home');
        }

        function closeGoFreightMatePanel() {
            isGoFreightMatePanelOpen = false;
            gofreightmatePanel.classList.add('hidden');
            gofreightmatePanel.classList.remove('flex');
            
            // 重置當前頁面為入口頁面
            currentGfmPage = 'home';
            
            // 隱藏所有頁面內容
            const hblSection = document.getElementById('hbl-section');
            if (hblSection) {
                hblSection.classList.add('hidden');
            }
            
            if (analysisTimeoutId) { clearTimeout(analysisTimeoutId); analysisTimeoutId = null; }
            gofreightmateContent.innerHTML = '<p class="text-center text-purple-600">點擊 GoFreightMate 按鈕開始分析。</p>';
            console.log("Panel closed.");
        }
        
        // 添加頁面切換功能
        function showGfmPage(pageName) {
            // 更新當前頁面追踪
            currentGfmPage = pageName;
            console.log("Switching to GFM page:", pageName);
            
            // 獲取所有頁面元素
            const homePage = document.getElementById('gfm-home-page');
            const dataExtractionPage = document.getElementById('gfm-data-extraction-page');
            const uploadPage = document.getElementById('gfm-upload-page');
            const updateGofreightBtn = document.getElementById('update-gofreight-btn');
            const uploadBtn = document.getElementById('upload-btn');
            
            // 隱藏所有頁面
            if (homePage) homePage.classList.add('hidden');
            if (dataExtractionPage) dataExtractionPage.classList.add('hidden');
            if (uploadPage) uploadPage.classList.add('hidden');
            
            // 首先確保所有按鈕都隱藏
            if (updateGofreightBtn) {
                updateGofreightBtn.classList.add('hidden');
                updateGofreightBtn.style.display = 'none';
            }
            if (uploadBtn) {
                uploadBtn.classList.add('hidden');
                uploadBtn.style.display = 'none';
            }
            
            // 根據頁面名稱顯示對應頁面和按鈕
            if (pageName === 'home') {
                if (homePage) homePage.classList.remove('hidden');
            }
            else if (pageName === 'data-extraction') {
                if (dataExtractionPage) dataExtractionPage.classList.remove('hidden');
                if (updateGofreightBtn) {
                    updateGofreightBtn.classList.remove('hidden');
                    
                    // 檢查郵件是否已更新並更新UI
                    if (currentOpenEmail && updatedEmailIds && updatedEmailIds.has(currentOpenEmail.id)) {
                        // 已經更新過，隱藏按鈕
                        updateGofreightBtn.style.display = 'none';
                        
                        // 顯示已更新標籤
                        const hblUpdatedBadge = document.getElementById('hbl-updated-badge');
                        if (hblUpdatedBadge) hblUpdatedBadge.classList.remove('hidden');
                        
                        // 禁用所有輸入欄位
                        setTimeout(() => {
                            disableAllInputFields();
                        }, 100);
                    } else {
                        // 未更新過，顯示按鈕
                        updateGofreightBtn.style.display = 'flex';
                    }
                }
                
                // 載入資料
                triggerGoFreightMateAnalysis(currentOpenEmail);
            }
            else if (pageName === 'upload') {
                if (uploadPage) uploadPage.classList.remove('hidden');
                if (uploadBtn) {
                    uploadBtn.classList.remove('hidden');
                    
                    // 檢查郵件是否已上傳
                    if (currentOpenEmail && uploadedEmailIds && uploadedEmailIds.has(currentOpenEmail.id)) {
                        // 已上傳過，隱藏按鈕
                        uploadBtn.style.display = 'none';
                    } else {
                        // 未上傳過，顯示按鈕
                        uploadBtn.style.display = 'flex';
                    }
                }
                
                // 清除之前的上傳成功訊息
                const uploadSuccess = document.getElementById('upload-success');
                if (uploadSuccess) uploadSuccess.classList.add('hidden');
                
                // 移除讀取指示器
                removeUploadLoadingIndicator();
                
                // 更新附件顯示
                updateAttachmentDisplay();
                
                // 更新已上傳狀態
                updateUploadedStatus();
            }
        }
        
        // 新增函數：更新附件顯示
        function updateAttachmentDisplay() {
            const attachmentList = document.getElementById('attachment-list');
            const noAttachmentAlert = document.getElementById('no-attachment-alert');
            const uploadBtn = document.getElementById('upload-btn');
            
            // 所有郵件現在都有附件
            let hasAttachments = true;
            
            if (hasAttachments) {
                if (attachmentList) attachmentList.classList.remove('hidden');
                if (noAttachmentAlert) noAttachmentAlert.classList.add('hidden');
                if (uploadBtn) uploadBtn.disabled = false;
                
                // 清空之前的附件
                if (attachmentList) attachmentList.innerHTML = '';
                
                // 根據郵件ID添加不同的附件
                if (currentOpenEmail) {
                    if (currentOpenEmail.id === 1) {
                        // Maersk ETA更新
                        if (attachmentList) {
                            attachmentList.innerHTML += `
                                <div class="attachment-item p-3 bg-gray-50 rounded-md mb-2">
                                    <div class="attachment-icon">
                                        <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i>
                                    </div>
                                    <div class="attachment-name font-medium">ETA_Update_MSKU1234567.pdf</div>
                                    <div class="attachment-size">156 KB</div>
                                </div>
                                <div class="attachment-item p-3 bg-gray-50 rounded-md">
                                    <div class="attachment-icon">
                                        <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i>
                                    </div>
                                    <div class="attachment-name font-medium">Delivery_Instructions.pdf</div>
                                    <div class="attachment-size">245 KB</div>
                                </div>
                            `;
                        }
                    } else if (currentOpenEmail.id === 2) {
                        // Evergreen 到達通知
                        if (attachmentList) {
                            attachmentList.innerHTML += `
                                <div class="attachment-item p-3 bg-gray-50 rounded-md mb-2">
                                    <div class="attachment-icon">
                                        <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i>
                                    </div>
                                    <div class="attachment-name font-medium">Arrival_Notice_EGLV1234567890.pdf</div>
                                    <div class="attachment-size">189 KB</div>
                                </div>
                                <div class="attachment-item p-3 bg-gray-50 rounded-md">
                                    <div class="attachment-icon">
                                        <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i>
                                    </div>
                                    <div class="attachment-name font-medium">Customs_Clearance_Form.pdf</div>
                                    <div class="attachment-size">134 KB</div>
                                </div>
                            `;
                        }
                    } else if (currentOpenEmail.id === 3) {
                        // 海關檢查通知
                        if (attachmentList) {
                            attachmentList.innerHTML += `
                                <div class="attachment-item p-3 bg-gray-50 rounded-md mb-2">
                                    <div class="attachment-icon">
                                        <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i>
                                    </div>
                                    <div class="attachment-name font-medium">CBP_Examination_Notice.pdf</div>
                                    <div class="attachment-size">167 KB</div>
                                </div>
                                <div class="attachment-item p-3 bg-gray-50 rounded-md">
                                    <div class="attachment-icon">
                                        <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i>
                                    </div>
                                    <div class="attachment-name font-medium">Required_Documents.pdf</div>
                                    <div class="attachment-size">210 KB</div>
                                </div>
                            `;
                        }
                    } else if (currentOpenEmail.id === 4) {
                        // 空櫃通知
                        if (attachmentList) {
                            attachmentList.innerHTML += `
                                <div class="attachment-item p-3 bg-gray-50 rounded-md mb-2">
                                    <div class="attachment-icon">
                                        <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i>
                                    </div>
                                    <div class="attachment-name font-medium">Empty_Container_Return.pdf</div>
                                    <div class="attachment-size">142 KB</div>
                                </div>
                                <div class="attachment-item p-3 bg-gray-50 rounded-md">
                                    <div class="attachment-icon">
                                        <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i>
                                    </div>
                                    <div class="attachment-name font-medium">Terminal_Map.pdf</div>
                                    <div class="attachment-size">325 KB</div>
                                </div>
                            `;
                        }
                    } else if (currentOpenEmail.id === 5) {
                        // IT系統維護通知
                        if (attachmentList) {
                            attachmentList.innerHTML += `
                                <div class="attachment-item p-3 bg-gray-50 rounded-md mb-2">
                                    <div class="attachment-icon">
                                        <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i>
                                    </div>
                                    <div class="attachment-name font-medium">System_Maintenance_Schedule.pdf</div>
                                    <div class="attachment-size">135 KB</div>
                                </div>
                                <div class="attachment-item p-3 bg-gray-50 rounded-md">
                                    <div class="attachment-icon">
                                        <i data-lucide="file-spreadsheet" class="w-5 h-5 text-green-600"></i>
                                    </div>
                                    <div class="attachment-name font-medium">IT_Contact_List.xlsx</div>
                                    <div class="attachment-size">95 KB</div>
                                </div>
                            `;
                        }
                    } else if (currentOpenEmail.id === 6) {
                        // 客戶詢問
                        if (attachmentList) {
                            attachmentList.innerHTML += `
                                <div class="attachment-item p-3 bg-gray-50 rounded-md mb-2">
                                    <div class="attachment-icon">
                                        <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i>
                                    </div>
                                    <div class="attachment-name font-medium">Shipping_Requirements.pdf</div>
                                    <div class="attachment-size">205 KB</div>
                                </div>
                                <div class="attachment-item p-3 bg-gray-50 rounded-md mb-2">
                                    <div class="attachment-icon">
                                        <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i>
                                    </div>
                                    <div class="attachment-name font-medium">Company_Profile.pdf</div>
                                    <div class="attachment-size">350 KB</div>
                                </div>
                                <div class="attachment-item p-3 bg-gray-50 rounded-md">
                                    <div class="attachment-icon">
                                        <i data-lucide="file-spreadsheet" class="w-5 h-5 text-green-600"></i>
                                    </div>
                                    <div class="attachment-name font-medium">Product_Specifications.xlsx</div>
                                    <div class="attachment-size">128 KB</div>
                                </div>
                            `;
                        }
                    } else if (currentOpenEmail.id === 7) {
                        // HR部門通知
                        if (attachmentList) {
                            attachmentList.innerHTML += `
                                <div class="attachment-item p-3 bg-gray-50 rounded-md mb-2">
                                    <div class="attachment-icon">
                                        <i data-lucide="file-text" class="w-5 h-5 text-indigo-600"></i>
                                    </div>
                                    <div class="attachment-name font-medium">Performance_Review_Form.docx</div>
                                    <div class="attachment-size">87 KB</div>
                                </div>
                                <div class="attachment-item p-3 bg-gray-50 rounded-md">
                                    <div class="attachment-icon">
                                        <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i>
                                    </div>
                                    <div class="attachment-name font-medium">Q1_Review_Guidelines.pdf</div>
                                    <div class="attachment-size">145 KB</div>
                                </div>
                            `;
                        }
                    } else if (currentOpenEmail.id === 8) {
                        // 進口貨物審查會議
                        if (attachmentList) {
                            attachmentList.innerHTML += `
                                <div class="attachment-item p-3 bg-gray-50 rounded-md mb-2">
                                    <div class="attachment-icon">
                                        <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i>
                                    </div>
                                    <div class="attachment-name font-medium">Shipment_Details_ONEABC123456.pdf</div>
                                    <div class="attachment-size">178 KB</div>
                                </div>
                                <div class="attachment-item p-3 bg-gray-50 rounded-md mb-2">
                                    <div class="attachment-icon">
                                        <i data-lucide="file-text" class="w-5 h-5 text-indigo-600"></i>
                                    </div>
                                    <div class="attachment-name font-medium">Meeting_Agenda.docx</div>
                                    <div class="attachment-size">65 KB</div>
                                </div>
                                <div class="attachment-item p-3 bg-gray-50 rounded-md">
                                    <div class="attachment-icon">
                                        <i data-lucide="file-spreadsheet" class="w-5 h-5 text-green-600"></i>
                                    </div>
                                    <div class="attachment-name font-medium">Delivery_Timeline.xlsx</div>
                                    <div class="attachment-size">120 KB</div>
                                </div>
                            `;
                        }
                    }
                }
                
                // 確保圖標被渲染
                if (typeof lucide !== 'undefined') {
                    try {
                        lucide.createIcons();
                    } catch (error) {
                        console.error("Error creating attachment icons:", error);
                    }
                }
            }
        }
        
        // 新增函數：更新已上傳狀態
        function updateUploadedStatus() {
            const previouslyUploadedIndicator = document.getElementById('previously-uploaded-indicator');
            const uploadBtn = document.getElementById('upload-btn');
            
            if (currentOpenEmail && uploadedEmailIds.has(currentOpenEmail.id)) {
                // 已上傳過
                previouslyUploadedIndicator.classList.remove('hidden');
            } else {
                // 未上傳過
                previouslyUploadedIndicator.classList.add('hidden');
            }
        }
        
        // 新增函數：處理附件上傳
        function handleAttachmentUpload() {
            const uploadBtn = document.getElementById('upload-btn');
            const uploadSuccess = document.getElementById('upload-success');
            const successMblNo = document.getElementById('success-mbl-no');
            const successContentType = document.getElementById('success-content-type');
            const successTime = document.getElementById('success-time');
            
            // 所有郵件都有附件
            let hasAttachments = true;
            
            // 顯示上傳中狀態
            uploadBtn.classList.add('btn-loading');
            uploadBtn.disabled = true;
            
            // 獲取選擇的上傳選項
            const uploadFullOption = document.getElementById('upload-full');
            const isFullUpload = uploadFullOption.checked;
            
            // 模擬上傳延遲
            setTimeout(() => {
                // 移除上傳中狀態
                uploadBtn.classList.remove('btn-loading');
                uploadBtn.disabled = false;
                
                // 顯示上傳成功訊息
                uploadSuccess.classList.remove('hidden');
                
                // 設置成功訊息內容
                successMblNo.textContent = currentMblNo;
                
                // 根據郵件類型設置不同的上傳內容描述
                let fileCount = 2; // 默認為2個文件
                if (currentOpenEmail) {
                    if (currentOpenEmail.id === 6) {
                        fileCount = 3; // 客戶詢問有3個附件
                    } else if (currentOpenEmail.id === 8) {
                        fileCount = 3; // 進口貨物審查會議有3個附件
                    }
                }
                
                successContentType.textContent = isFullUpload ? 
                    `Email & Attachments (${fileCount} files)` : `Attachments Only (${fileCount} files)`;
                
                // 獲取當前時間作為上傳時間
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                successTime.textContent = `${dateStr} ${timeStr}`;
                
                // 記錄此郵件已上傳過附件
                if (currentOpenEmail) {
                    uploadedEmailIds.add(currentOpenEmail.id);
                }
                
                // 隱藏上傳按鈕
                uploadBtn.style.display = 'none';
                
                // 更新已上傳狀態指示器
                updateUploadedStatus();
                
                // 確保圖標被渲染
                if (typeof lucide !== 'undefined') {
                    try {
                        lucide.createIcons();
                    } catch (error) {
                        console.error("Error creating icons after upload success:", error);
                    }
                }
            }, 1500);
        }

        function createFieldHtml(label, currentData, aiData, fieldType = 'text') {
            let inputHtml = '';
            
            // 根據字段類型生成不同的輸入元素
            switch(fieldType) {
                case 'date':
                    inputHtml = `
                        <input type="text" class="gfm-date-picker" value="${aiData || ''}" placeholder="YYYY-MM-DD, HH:MM">
                    `;
                    break;
                case 'vessel':
                    inputHtml = `
                        <div class="gfm-autocomplete-wrapper">
                            <input type="text" class="gfm-autocomplete-input" value="${aiData || ''}" placeholder="Start typing vessel name...">
                            <div class="gfm-autocomplete-dropdown">
                                <div class="gfm-autocomplete-item">MAERSK HONG KONG</div>
                                <div class="gfm-autocomplete-item">EVER ACE</div>
                                <div class="gfm-autocomplete-item">MSC OSCAR</div>
                                <div class="gfm-autocomplete-item">ONE OLYMPUS</div>
                                <div class="gfm-autocomplete-item">CMA CGM J. MADISON</div>
                            </div>
                        </div>
                    `;
                    break;
                case 'port':
                    inputHtml = `
                        <div class="gfm-autocomplete-wrapper">
                            <input type="text" class="gfm-autocomplete-input" value="${aiData || ''}" placeholder="Start typing port name...">
                            <div class="gfm-autocomplete-dropdown">
                                <div class="gfm-autocomplete-item">Los Angeles (USLAX)</div>
                                <div class="gfm-autocomplete-item">New York (USNYC)</div>
                                <div class="gfm-autocomplete-item">Singapore (SGSIN)</div>
                                <div class="gfm-autocomplete-item">Shanghai (CNSHA)</div>
                                <div class="gfm-autocomplete-item">Taipei (TWTPE)</div>
                                <div class="gfm-autocomplete-item">Houston (USHOU)</div>
                            </div>
                        </div>
                    `;
                    break;
                case 'location':
                    inputHtml = `
                        <div class="gfm-select-wrapper">
                            <select class="gfm-select">
                                <option value="">${aiData || 'Select a location'}</option>
                                <option value="SAMSUNG C AND T AMERICA INC.">SAMSUNG C AND T AMERICA INC.</option>
                                <option value="JONES, CLAYTON AND HARRIS">JONES, CLAYTON AND HARRIS</option>
                                <option value="PACIFIC TERMINAL">PACIFIC TERMINAL</option>
                                <option value="AMERICAN LOGISTICS">AMERICAN LOGISTICS</option>
                                <option value="GLOBAL WAREHOUSE">GLOBAL WAREHOUSE</option>
                            </select>
                            <div class="gfm-select-arrow">
                                <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </div>
                        </div>
                    `;
                    break;
                case 'container':
                    inputHtml = `
                        <input type="text" class="gfm-card-input" value="${aiData || ''}" pattern="[A-Z]{4}[0-9]{7}" placeholder="e.g., MSKU1234567">
                    `;
                    break;
                default:
                    inputHtml = `
                        <input type="text" class="gfm-card-input" value="${aiData || ''}">
                    `;
            }

            return `
                <div class="gfm-card" data-field-label="${label}">
                    <div class="gfm-card-header">
                        <div class="gfm-card-title">
                            <i data-lucide="clipboard-list" class="w-4 h-4"></i>
                            ${label}
                        </div>
                        <div class="gfm-card-checkbox" title="勾選此欄位以更新至GoFreight">
                            <input type="checkbox" id="update-${label.replace(/\s+/g, '-').toLowerCase()}" class="field-update-checkbox" checked>
                            <label for="update-${label.replace(/\s+/g, '-').toLowerCase()}" class="sr-only">更新此欄位</label>
                        </div>
                    </div>
                    <div class="gfm-card-content">
                        <div class="gfm-card-row">
                            <div class="gfm-card-label">GoFreight Current Data:</div>
                            <div class="gfm-card-value current">${currentData || '<i>(None)</i>'}</div>
                        </div>
                        <div class="gfm-card-row">
                            <div class="gfm-card-label">AI Extracted Data:</div>
                            <div class="gfm-card-value ai">${aiData || '<i>(Not extracted)</i>'}</div>
                        </div>
                        <div class="gfm-card-row">
                            <div class="gfm-card-label">Update Data:</div>
                            ${inputHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        function populateGoFreightMateContent(email) {
            if (!email) { 
                gofreightmateContent.innerHTML = '<p class="text-red-600">錯誤: 無法讀取郵件內容。</p>'; 
                return; 
            }
            console.log("Populating content for email ID:", email.id);
            gofreightmateContent.innerHTML = '';
            
            // 只有在數據分析頁面顯示HBL部分
            if (currentGfmPage === 'data-extraction') {
                // Show HBL section
                const hblSection = document.getElementById('hbl-section');
                if (hblSection) {
                    hblSection.classList.remove('hidden');
                }
                
                // 檢查此郵件是否已更新並更新 UI
                const hblUpdatedBadge = document.getElementById('hbl-updated-badge');
                const updateGofreightBtn = document.getElementById('update-gofreight-btn');
                
                if (updatedEmailIds && updatedEmailIds.has(email.id)) {
                    // 已經更新過，顯示標籤並隱藏按鈕
                    if (hblUpdatedBadge) hblUpdatedBadge.classList.remove('hidden');
                    if (updateGofreightBtn) updateGofreightBtn.style.display = 'none';
                    
                    // 在填充內容之後禁用所有欄位
                    setTimeout(() => {
                        disableAllInputFields();
                    }, 100);
                } else {
                    // 未更新過，隱藏標籤並顯示按鈕
                    if (hblUpdatedBadge) hblUpdatedBadge.classList.add('hidden');
                    if (updateGofreightBtn) updateGofreightBtn.style.display = 'flex';
                }
            }
            
            // 更新上傳頁面的MB/L No.顯示
            if (currentGfmPage === 'upload') {
                // 根據不同的郵件設置不同的MB/L No.
                updateMblNoForEmail(email);
                
                // 更新附件列表
                updateAttachmentDisplay();
                
                // 更新已上傳狀態
                updateUploadedStatus();
                
                return; // 不需要繼續執行數據掃描頁面的內容
            }
            
            // 以下是數據掃描頁面的內容處理
            // Update HB/L No. display based on current email
            updateHblNoForEmail(email);
            
            // 顯示自定義欄位區域（如果郵件可分析）
            const customFieldContainer = document.getElementById('custom-field-container');
            if (customFieldContainer) {
                if (email.id === 1 || email.id === 2 || email.id === 3 || email.id === 4 || email.id === 8) {
                    // 可分析的郵件，顯示自定義欄位區域
                    customFieldContainer.classList.remove('hidden');
                } else {
                    // 不可分析的郵件，隱藏自定義欄位區域
                    customFieldContainer.classList.add('hidden');
                }
            }
            
            // 初始化欄位選擇功能（在內容填充後）
            setTimeout(() => {
                handleFieldSelectionToggle();
                setupCustomFieldFunctionality();
            }, 100);
            
            // 確保圖標被渲染
            if (typeof lucide !== 'undefined') {
                try {
                    lucide.createIcons();
                } catch (error) {
                    console.error("Error creating icons after populating content:", error);
                }
            }
        }

        // 新增函數：根據郵件更新HBL號碼
        function updateHblNoForEmail(email) {
            if (!email) return;
            
            const hblDisplay = document.getElementById('hbl-display');
            const hblInput = document.getElementById('hbl-input');
            
            if (email.id === 1) {
                // Maersk 更新信件，可分析可更新
                currentHblNo = "MSKU1234567";
                if (hblDisplay) hblDisplay.textContent = currentHblNo;
                if (hblInput) hblInput.value = currentHblNo;
                
                gofreightmateContent.innerHTML += createFieldHtml('Container No.', 'MSKU1234567', 'MSKU1234567', 'container');
                gofreightmateContent.innerHTML += createFieldHtml('Vessel/Voyage', 'MAERSK HONG KONG / 2401', 'MAERSK HONG KONG V.2401', 'vessel');
                gofreightmateContent.innerHTML += createFieldHtml('ETA', 'April 18, 2025, 08:00 PST', 'April 18, 2025, 14:00 PST', 'date');
                gofreightmateContent.innerHTML += createFieldHtml('Destination', 'Los Angeles, CA', 'Port of Los Angeles (USLAX)', 'port');
            } 
            else if (email.id === 2) {
                // Evergreen 到達通知，可分析但不可更新
                currentHblNo = "EGLV1234567890";
                if (hblDisplay) hblDisplay.textContent = currentHblNo;
                if (hblInput) hblInput.value = currentHblNo;
                
                gofreightmateContent.innerHTML += createFieldHtml('Container No.', '<i>(None)</i>', 'EISU9876543', 'container');
                gofreightmateContent.innerHTML += createFieldHtml('Vessel/Voyage', 'EVER ACE / 014E', 'EVER ACE V.015E', 'vessel');
                gofreightmateContent.innerHTML += createFieldHtml('Est. Discharge Date', 'April 16, 2025', 'April 17, 2025', 'date');
                gofreightmateContent.innerHTML += createFieldHtml('Last Free Day', 'April 20, 2025', 'April 21, 2025', 'date');
                gofreightmateContent.innerHTML += createFieldHtml('POD/Location', 'Taipei Port', 'Taipei Port (TW TPE)', 'port');
                gofreightmateContent.innerHTML += createFieldHtml('CY/CFS Location', 'JONES, CLAYTON AND HARRIS', 'SAMSUNG C AND T AMERICA INC.', 'location');
            }
            else if (email.id === 3) {
                // 海關檢查通知，可分析
                currentHblNo = "MEDU0098765432";
                if (hblDisplay) hblDisplay.textContent = currentHblNo;
                if (hblInput) hblInput.value = currentHblNo;
                
                gofreightmateContent.innerHTML += createFieldHtml('Container No.', '<i>(None)</i>', 'MSDU4456789', 'container');
                gofreightmateContent.innerHTML += createFieldHtml('Vessel/Voyage', '<i>(None)</i>', 'MSC ANTONIA / 445E', 'vessel');
                gofreightmateContent.innerHTML += createFieldHtml('Entry Number', '<i>(None)</i>', '235-98754611', 'text');
                gofreightmateContent.innerHTML += createFieldHtml('Exam Date', '<i>(None)</i>', 'April 18, 2025', 'date');
                gofreightmateContent.innerHTML += createFieldHtml('Exam Location', '<i>(None)</i>', 'CES Facility LAX', 'location');
                gofreightmateContent.innerHTML += createFieldHtml('Port of Entry', 'Los Angeles', 'Los Angeles/Long Beach', 'port');
            }
            else if (email.id === 4) {
                // 空櫃歸還通知，可分析
                currentHblNo = "ONEA12354697";
                if (hblDisplay) hblDisplay.textContent = currentHblNo;
                if (hblInput) hblInput.value = currentHblNo;
                
                gofreightmateContent.innerHTML += createFieldHtml('Container No.', '<i>(None)</i>', 'ONEY6754321, ONEY9988765', 'container');
                gofreightmateContent.innerHTML += createFieldHtml('Booking Reference', '<i>(None)</i>', 'ONEHAN220500123', 'text');
                gofreightmateContent.innerHTML += createFieldHtml('Last Free Day', 'April 21, 2025', 'April 20, 2025', 'date');
                gofreightmateContent.innerHTML += createFieldHtml('Return Location', '<i>(None)</i>', 'ONE Terminal Oakland', 'location');
            }
            else if (email.id === 8) {
                // 進口貨物審查會議，可分析
                currentHblNo = "ONEABC123456";
                if (hblDisplay) hblDisplay.textContent = currentHblNo;
                if (hblInput) hblInput.value = currentHblNo;
                
                gofreightmateContent.innerHTML += createFieldHtml('Container No.', '<i>(None)</i>', 'NYKU7654321, NYKU7654322', 'container');
                gofreightmateContent.innerHTML += createFieldHtml('Vessel/Voyage', '<i>(None)</i>', 'ONE OPAL V.236E', 'vessel');
                gofreightmateContent.innerHTML += createFieldHtml('ETA', '<i>(None)</i>', 'April 19, 2025', 'date');
                gofreightmateContent.innerHTML += createFieldHtml('Customer', '<i>(None)</i>', 'Premium Electronics Inc.', 'text');
            }
            else {
                // 其他普通郵件，不可分析
                currentHblNo = "N/A";
                if (hblDisplay) hblDisplay.textContent = currentHblNo;
                if (hblInput) hblInput.value = currentHblNo;
                
                gofreightmateContent.innerHTML = '<p class="text-purple-700 text-center">此郵件不含可被 GoFreightMate 分析的運輸數據。</p>';
                
                // 隱藏 HBL 區域，因為這不是可分析的郵件
                const hblSection = document.getElementById('hbl-section');
                if (hblSection) {
                    hblSection.classList.add('hidden');
                }
                
                // 隱藏更新按鈕
                const updateGofreightBtn = document.getElementById('update-gofreight-btn');
                if (updateGofreightBtn) {
                    updateGofreightBtn.style.display = 'none';
                }
            }
            
            // 初始化自動完成下拉選單功能
            initializeAutoComplete();
        }

        // 新增函數：根據郵件更新MBL號碼和相關顯示
        function updateMblNoForEmail(email) {
            if (!email) return;
            
            // 根據不同的郵件設置不同的MB/L No.
            if (email.id === 1) {
                currentMblNo = "KIOR294757356";
            } else if (email.id === 2) {
                currentMblNo = "EGLV1234567890";
            } else if (email.id === 3) {
                currentMblNo = "MEDU0098765432";
            } else if (email.id === 4) {
                currentMblNo = "ONEA12354697";
            } else if (email.id === 5) {
                // IT部門通知 - 沒有MBL號碼
                currentMblNo = "N/A";
            } else if (email.id === 8) {
                currentMblNo = "ONEABC123456";
            } else {
                currentMblNo = "N/A";
            }
            
            // 更新MB/L No.顯示
            const mblDisplay = document.getElementById('mbl-display');
            const mblInput = document.getElementById('mbl-input');
            if (mblDisplay) mblDisplay.textContent = currentMblNo;
            if (mblInput) mblInput.value = currentMblNo;
        }

        // 新增自動完成下拉選單的初始化函數
        function initializeAutoComplete() {
            // 獲取所有自動完成輸入框
            const autoCompleteInputs = document.querySelectorAll('.gfm-autocomplete-input');
            
            autoCompleteInputs.forEach(input => {
                // 監聽焦點事件
                input.addEventListener('focus', function() {
                    const wrapper = this.closest('.gfm-autocomplete-wrapper');
                    wrapper.classList.add('active');
                });
                
                // 監聽失焦事件
                input.addEventListener('blur', function() {
                    // 延遲關閉下拉菜單，以便能夠點擊選項
                    setTimeout(() => {
                        const wrapper = this.closest('.gfm-autocomplete-wrapper');
                        wrapper.classList.remove('active');
                    }, 200);
                });
                
                // 監聽輸入事件實現過濾功能
                input.addEventListener('input', function() {
                    const wrapper = this.closest('.gfm-autocomplete-wrapper');
                    const dropdown = wrapper.querySelector('.gfm-autocomplete-dropdown');
                    const items = dropdown.querySelectorAll('.gfm-autocomplete-item');
                    const value = this.value.toLowerCase();
                    
                    items.forEach(item => {
                        if (item.textContent.toLowerCase().includes(value)) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                    
                    // 如果有輸入內容則顯示下拉菜單
                    if (value.length > 0) {
                        wrapper.classList.add('active');
                    }
                });
            });
            
            // 獲取所有自動完成下拉選項
            const autoCompleteItems = document.querySelectorAll('.gfm-autocomplete-item');
            
            autoCompleteItems.forEach(item => {
                // 監聽點擊事件
                item.addEventListener('click', function() {
                    const wrapper = this.closest('.gfm-autocomplete-wrapper');
                    const input = wrapper.querySelector('.gfm-autocomplete-input');
                    input.value = this.textContent;
                    wrapper.classList.remove('active');
                });
            });
        }

        // --- Email List and Reading Pane Functions ---
        function displayEmails() {
            emailListContainer.innerHTML = '';
            emails.forEach(email => {
                const emailItem = document.createElement('div');
                emailItem.classList.add('email-item', 'p-4', 'border-b', 'border-gray-200', 'cursor-pointer', 'hover:bg-gray-100', 'relative');
                if (email.unread) { emailItem.classList.add('unread'); }
                emailItem.dataset.emailId = email.id;
                emailItem.innerHTML = `
                    ${email.unread ? '<span class="absolute left-1 top-1/2 transform -translate-y-1/2 w-2 h-2 bg-blue-600 rounded-full"></span>' : ''}
                    <div class="flex justify-between items-center mb-1 pl-3"> <span class="font-semibold text-sm ${email.unread ? 'text-gray-900' : 'text-gray-700'}">${email.sender}</span> <span class="text-xs ${email.unread ? 'text-blue-600 font-medium' : 'text-gray-500'}">${email.timestamp}</span> </div>
                    <div class="text-sm ${email.unread ? 'font-semibold text-gray-900' : 'text-gray-700'} mb-1 pl-3">${email.subject}</div>
                    <div class="text-xs text-gray-500 truncate pl-3">${email.snippet}</div>
                `;
                emailItem.addEventListener('click', () => {
                    const clickedEmailId = parseInt(emailItem.dataset.emailId);
                    const clickedEmail = emails.find(e => e.id === clickedEmailId);
                    if (!clickedEmail) return;
                    currentOpenEmail = clickedEmail;
                    
                    // 標記郵件為已讀
                    if (clickedEmail.unread) {
                        clickedEmail.unread = false;
                        emailItem.classList.remove('unread');
                        const blueIndicatorDot = emailItem.querySelector('.absolute.left-1');
                        if (blueIndicatorDot) blueIndicatorDot.style.display = 'none';
                        emailItem.querySelectorAll('.font-semibold').forEach(el => el.classList.replace('font-semibold','font-normal'));
                        emailItem.querySelectorAll('.text-gray-900').forEach(el => el.classList.replace('text-gray-900','text-gray-700'));
                        emailItem.querySelectorAll('.text-blue-600').forEach(el => el.classList.replace('text-blue-600','text-gray-500'));
                        updateUnreadCount();
                    }
                    
                    displayEmailContent(clickedEmail);
                    
                    // 更新選中狀態
                    if (selectedEmailItem && selectedEmailItem !== emailItem) {
                        selectedEmailItem.classList.remove('selected');
                    }
                    emailItem.classList.add('selected');
                    selectedEmailItem = emailItem;
                    
                    // 如果面板已開啟，根據當前頁面重新觸發相應功能
                    if (isGoFreightMatePanelOpen) {
                        console.log("Panel is open, auto-triggering analysis for new email.");
                        
                        // 根據當前頁面重新處理
                        if (currentGfmPage === 'data-extraction') {
                            showLoadingIndicator();
                            if (analysisTimeoutId) { 
                                clearTimeout(analysisTimeoutId); 
                            }
                            analysisTimeoutId = setTimeout(() => {
                                populateGoFreightMateContent(currentOpenEmail);
                                analysisTimeoutId = null;
                            }, 1000);
                        } else if (currentGfmPage === 'upload') {
                            // 顯示上傳頁面的讀取狀態
                            showUploadLoadingIndicator();
                            setTimeout(() => {
                                showGfmPage('upload');
                            }, 800);
                        } else {
                            // 入口頁面
                            showGfmPage('home');
                        }
                    }
                });
                emailListContainer.appendChild(emailItem);
            });
             updateUnreadCount();
        }

        function displayEmailContent(email) {
            readingPanePlaceholder.classList.add('hidden');
            emailContentArea.classList.remove('hidden');
            emailContentArea.classList.add('flex');
            emailSubject.textContent = email.subject;
            emailSender.textContent = email.sender;
            senderInitial.textContent = email.senderInitial;
            emailTimestamp.textContent = email.timestamp;
            
            // 只替換郵件正文部分，而不是整個email-body
            const emailContent = document.getElementById('email-content');
            if (emailContent) {
                emailContent.innerHTML = email.body;
            }
            
            // 顯示附件區域
            const emailAttachments = document.getElementById('email-attachments');
            const attachmentList = document.querySelector('.email-attachment-list');
            
            // 清空之前的附件
            if (attachmentList) attachmentList.innerHTML = '';
            
            // 確保附件區域可見
            if (emailAttachments) {
                emailAttachments.style.display = 'block';
                emailAttachments.style.marginTop = '20px';
                emailAttachments.style.padding = '15px';
                emailAttachments.style.backgroundColor = '#f9fafb';
                emailAttachments.style.borderRadius = '8px';
                emailAttachments.style.border = '1px solid #e5e7eb';
            }
            
            if (email.attachments && email.attachments.length > 0) {
                // 遍歷附件數組並顯示每個附件
                email.attachments.forEach(attachment => {
                    let fileIcon = 'file-text';
                    let iconColor = 'text-blue-600';
                    
                    // 根據附件類型決定圖標和顏色
                    if (attachment.type === 'pdf') {
                        fileIcon = 'file-text';
                        iconColor = 'text-red-600';
                    } else if (attachment.type === 'excel') {
                        fileIcon = 'file-spreadsheet';
                        iconColor = 'text-green-600';
                    } else if (attachment.type === 'word') {
                        fileIcon = 'file-text';
                        iconColor = 'text-blue-600';
                    } else if (attachment.type === 'image') {
                        fileIcon = 'image';
                        iconColor = 'text-purple-600';
                    } else if (attachment.type === 'archive') {
                        fileIcon = 'archive';
                        iconColor = 'text-yellow-600';
                    }
                    
                    const attachmentItem = `
                            <div class="flex items-center gap-2 p-3 bg-white hover:bg-gray-100 rounded cursor-pointer border border-gray-200 my-1">
                            <i data-lucide="${fileIcon}" class="w-5 h-5 ${iconColor}"></i>
                            <span class="text-sm text-gray-800 font-medium">${attachment.name}</span>
                            <span class="text-xs text-gray-500 ml-auto">${attachment.size}</span>
                                <button class="p-1 hover:bg-gray-200 rounded">
                                <i data-lucide="download" class="w-4 h-4 text-gray-600"></i>
                                </button>
                            </div>
                    `;
                    
                    if (attachmentList) attachmentList.innerHTML += attachmentItem;
                });
            } else {
                // 即使沒有附件，也顯示一個提示
                if (attachmentList) {
                    attachmentList.innerHTML = `
                        <div class="flex items-center p-3 bg-gray-50 rounded border border-gray-200">
                            <i data-lucide="info" class="w-5 h-5 text-gray-400 mr-2"></i>
                            <span class="text-sm text-gray-500">No attachments in this email.</span>
                        </div>
                    `;
                }
            }
            
            // 確保圖標被渲染
            console.log("嘗試渲染附件圖標");
            setTimeout(() => {
                if (typeof lucide !== 'undefined') {
                    try {
                        lucide.createIcons();
                        console.log("附件圖標渲染成功");
                    } catch (error) {
                        console.error("渲染附件圖標時出錯:", error);
                    }
                } else {
                    console.error("Lucide 未定義，無法渲染附件圖標");
                }
            }, 100);
            
            // 清除之前的狀態訊息
            const statusMessage = document.getElementById('status-message');
            if (statusMessage) {
                statusMessage.classList.add('hidden');
                statusMessage.classList.remove('success', 'error');
                statusMessage.innerHTML = '';
            }
            
            // 如果 GoFreightMate 面板已開啟，根據當前頁面更新UI
            if (isGoFreightMatePanelOpen) {
                if (currentGfmPage === 'home') {
                    // 入口頁面，不需要特殊處理
                    showGfmPage('home');
                }
                else if (currentGfmPage === 'data-extraction') {
                    // 更新數據掃描頁面
                    showGfmPage('data-extraction');
                }
                else if (currentGfmPage === 'upload') {
                    // 更新上傳頁面，先顯示讀取中狀態
                    showUploadLoadingIndicator();
                    setTimeout(() => {
                        showGfmPage('upload');
                    }, 800);
                }
            }
            
            // 再次確保新添加的圖標被渲染
            if (typeof lucide !== 'undefined') {
                try {
                    lucide.createIcons();
                    console.log("郵件內容圖標渲染成功");
                } catch (error) {
                    console.error("渲染郵件內容圖標時出錯:", error);
                }
            } else {
                console.error("Lucide 未定義，無法渲染郵件內容圖標");
            }
        }

        // ... rest of the code ...

        function disableAllInputFields() {
            // 禁用選中的欄位的輸入框
            document.querySelectorAll('.field-update-checkbox:checked').forEach(checkbox => {
                const card = checkbox.closest('.gfm-card');
                if (!card) return;
                
                // 標記卡片為已更新
                card.classList.add('updated');
                
                // 禁用該卡片中的所有輸入元素
                const inputs = card.querySelectorAll('.gfm-card-input, .gfm-date-picker, .gfm-autocomplete-input, .gfm-select');
                inputs.forEach(input => {
                    input.disabled = true;
                });
                
                // 禁用複選框
                checkbox.disabled = true;
            });
            
            // 禁用 HB/L 編輯按鈕
            const hblEditButton = document.getElementById('hbl-edit-button');
            if (hblEditButton) {
                hblEditButton.disabled = true;
                hblEditButton.style.opacity = '0.5';
                hblEditButton.style.cursor = 'not-allowed';
            }
            
            // 禁用添加自定義欄位按鈕
            const addCustomFieldBtn = document.getElementById('add-custom-field-btn');
            if (addCustomFieldBtn) {
                addCustomFieldBtn.style.pointerEvents = 'none';
                addCustomFieldBtn.style.opacity = '0.5';
            }
            
            // 禁用所有刪除自定義欄位按鈕
            document.querySelectorAll('.delete-custom-field').forEach(button => {
                button.disabled = true;
                button.style.opacity = '0.5';
                button.style.pointerEvents = 'none';
            });
        }
        
        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', (event) => {
            console.log("DOMContentLoaded event fired.");

            // 立即嘗試初始化Lucide圖標
            if (typeof lucide !== 'undefined') {
                try {
                    lucide.createIcons();
                    console.log("Initial Lucide icons creation successful");
                } catch (error) {
                    console.error("Error in initial Lucide icons creation:", error);
                }
            }

            // --- Robust Lucide Initialization with Polling ---
            const maxWaitTime = 5000; // Max wait 5 seconds for Lucide
            const checkInterval = 100; // Check every 100ms
            let elapsedTime = 0;

            lucideCheckInterval = setInterval(() => {
                elapsedTime += checkInterval;

                if (typeof lucide !== 'undefined') {
                    console.log("Lucide object found after", elapsedTime, "ms.");
                    clearInterval(lucideCheckInterval); // Stop polling
                    if(lucideCheckTimeout) clearTimeout(lucideCheckTimeout); // Clear timeout timer
                    try {
                        lucide.createIcons();
                        console.log("Lucide icons initialized successfully.");
                    } catch (error) {
                        console.error("Error initializing Lucide icons:", error);
                    }
                } else if (elapsedTime >= maxWaitTime) {
                     console.error("Lucide library failed to load within", maxWaitTime / 1000, "seconds.");
                     clearInterval(lucideCheckInterval); // Stop polling
                     if(lucideCheckTimeout) clearTimeout(lucideCheckTimeout); // Clear timeout timer
                }
            }, checkInterval);

            // Set a timeout to ensure the interval stops even if lucide never loads
            lucideCheckTimeout = setTimeout(() => {
                 if (lucideCheckInterval) { // Check if interval is still running
                     console.error("Lucide check timed out after", maxWaitTime / 1000, "seconds.");
                     clearInterval(lucideCheckInterval);
                 }
            }, maxWaitTime + 50); // Add a small buffer to timeout

            displayEmails(); // 填充郵件列表
            
            // 自動打開第一封郵件以顯示附件
            setTimeout(() => {
                const firstEmailItem = document.querySelector('.email-item');
                if (firstEmailItem) {
                    console.log("自動打開第一封郵件");
                    firstEmailItem.click();
                    
                    // 在郵件打開後額外渲染一次圖標
                    setTimeout(() => {
                        if (typeof lucide !== 'undefined') {
                            try {
                                lucide.createIcons();
                                console.log("附加的圖標渲染：郵件打開後");
                            } catch (error) {
                                console.error("郵件打開後渲染圖標出錯:", error);
                            }
                        }
                    }, 300);
                }
            }, 500);
            
            // --- Attach Sidebar Toggle Listener ---
            if (sidebarToggleButton && sidebar) {
                 sidebarToggleButton.addEventListener('click', toggleSidebar);
                 console.log("Sidebar toggle button listener attached.");
            } else {
                 console.error("Sidebar or Sidebar toggle button not found!");
            }
            // --- Attach GoFreightMate Listeners ---
            if (gofreightmateButton) { gofreightmateButton.addEventListener('click', openGoFreightMatePanel); console.log("GoFreightMate button listener attached."); }
            else { console.error("GoFreightMate button not found when attaching listener!"); }
            if (gofreightmateCloseButton) { gofreightmateCloseButton.addEventListener('click', closeGoFreightMatePanel); console.log("GoFreightMate close button listener attached."); }
            else { console.error("GoFreightMate close button not found!"); }

            // 入口頁面功能卡片監聽
            const dataExtractionCard = document.getElementById('data-extraction-card');
            const fileUploadCard = document.getElementById('file-upload-card');
            
            if (dataExtractionCard) {
                dataExtractionCard.addEventListener('click', () => {
                    showGfmPage('data-extraction');
                });
            }
            
            if (fileUploadCard) {
                fileUploadCard.addEventListener('click', () => {
                    showGfmPage('upload');
                });
            }
            
            // 返回按鈕監聽
            const backButtons = document.querySelectorAll('.back-button');
            backButtons.forEach(button => {
                button.addEventListener('click', () => {
                    showGfmPage('home');
                });
            });
            
            // 上傳選項切換監聽
            const uploadOptions = document.querySelectorAll('.upload-option');
            uploadOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // 移除所有選項的選中狀態
                    uploadOptions.forEach(opt => opt.classList.remove('selected'));
                    
                    // 給當前點擊的選項添加選中狀態
                    this.classList.add('selected');
                    
                    // 選中對應的radio按鈕
                    const radioBtn = this.querySelector('input[type="radio"]');
                    if (radioBtn) {
                        radioBtn.checked = true;
                    }
                });
            });
            
            // 附件上傳按鈕監聽
            const uploadBtn = document.getElementById('upload-btn');
            if (uploadBtn) {
                uploadBtn.addEventListener('click', handleAttachmentUpload);
            }
            
            // MB/L編輯功能
            const mblEditButton = document.getElementById('mbl-edit-button');
            const mblSaveButton = document.getElementById('mbl-save-button');
            const mblDisplay = document.getElementById('mbl-display');
            const mblEditForm = document.getElementById('mbl-edit-form');
            const mblInput = document.getElementById('mbl-input');
            
            if (mblEditButton) {
                mblEditButton.addEventListener('click', () => {
                    mblDisplay.classList.add('hidden');
                    mblEditForm.classList.remove('hidden');
                    mblInput.focus();
                    mblInput.select();
                });
            }
            
            if (mblSaveButton) {
                mblSaveButton.addEventListener('click', () => {
                    const newMblNo = mblInput.value.trim();
                    if (newMblNo) {
                        currentMblNo = newMblNo;
                        mblDisplay.textContent = currentMblNo;
                    }
                    mblEditForm.classList.add('hidden');
                    mblDisplay.classList.remove('hidden');
                });
            }

             // Initial state setup
             if (gofreightmatePanel) { gofreightmatePanel.classList.add('hidden'); gofreightmatePanel.classList.remove('flex'); }

            // Initialize HB/L editing functionality
            const hblEditButton = document.getElementById('hbl-edit-button');
            const hblSaveButton = document.getElementById('hbl-save-button');
            const hblDisplay = document.getElementById('hbl-display');
            const hblEditForm = document.getElementById('hbl-edit-form');
            const hblInput = document.getElementById('hbl-input');

            if (hblEditButton) {
                hblEditButton.addEventListener('click', () => {
                    hblDisplay.classList.add('hidden');
                    hblEditForm.classList.remove('hidden');
                    hblInput.focus();
                    hblInput.select();
                });
            }

            if (hblSaveButton) {
                hblSaveButton.addEventListener('click', () => {
                    const newHblNo = hblInput.value.trim();
                    if (newHblNo !== currentHblNo) {
                        currentHblNo = newHblNo;
                        hblDisplay.textContent = currentHblNo;
                        
                        // If there's an open email, re-trigger analysis
                        if (currentOpenEmail) {
                            showLoadingIndicator();
                            if (analysisTimeoutId) { 
                                clearTimeout(analysisTimeoutId); 
                            }
                            analysisTimeoutId = setTimeout(() => {
                                populateGoFreightMateContent(currentOpenEmail);
                                analysisTimeoutId = null;
                            }, 1000);
                        }
                    }
                    hblEditForm.classList.add('hidden');
                    hblDisplay.classList.remove('hidden');
                });
            }

            // 初始化按鈕的讀取狀態控制
            const updateGofreightBtn = document.getElementById('update-gofreight-btn');
            const statusMessage = document.getElementById('status-message');
            const hblUpdatedBadge = document.getElementById('hbl-updated-badge');
            
            // 按鈕點擊事件
            if (updateGofreightBtn) {
                updateGofreightBtn.addEventListener('click', function() {
                    if (!currentOpenEmail) return;
                    
                    // 獲取選中的欄位
                    const selectedFields = getSelectedFieldIds();
                    console.log("選中更新的欄位:", selectedFields);
                    
                    // 如果沒有選中任何欄位，提示用戶
                    if (selectedFields.length === 0) {
                        statusMessage.innerHTML = `<i data-lucide="alert-circle"></i> 請至少選擇一個欄位進行更新。`;
                        statusMessage.classList.add('error');
                        statusMessage.classList.remove('hidden', 'success');
                        
                        if (typeof lucide !== 'undefined') {
                            try {
                                lucide.createIcons();
                            } catch (error) {
                                console.error("Error creating icons for status message:", error);
                            }
                        }
                        return;
                    }
                    
                    // 顯示讀取狀態
                    this.classList.add('btn-loading');
                    this.disabled = true;
                    
                    // 清除上一次的狀態消息
                    statusMessage.classList.add('hidden');
                    statusMessage.classList.remove('success', 'error');
                    
                    // 模擬 API 請求延遲
                    setTimeout(() => {
                        // 移除讀取狀態
                        this.classList.remove('btn-loading');
                        this.disabled = false;
                        
                        // 根據郵件 ID 決定成功或失敗
                        // Email ID 1, 3, 4 會成功，其他會失敗
                        if (currentOpenEmail.id === 1 || currentOpenEmail.id === 3 || currentOpenEmail.id === 4) {
                            // 成功狀態
                            statusMessage.innerHTML = `<i data-lucide="check-circle"></i> 成功將 ${selectedFields.length} 個欄位更新至 GoFreight。`;
                            statusMessage.classList.add('success');
                            statusMessage.classList.remove('hidden');
                            
                            // 顯示已更新標籤
                            hblUpdatedBadge.classList.remove('hidden');
                            
                            // 禁用更新按鈕
                            this.style.display = 'none';
                            
                            // 記錄這個 email 已經更新
                            updatedEmailIds.add(currentOpenEmail.id);
                            
                            // 禁用所有輸入欄位
                            disableAllInputFields();
                        } else {
                            // 失敗狀態
                            statusMessage.innerHTML = `<i data-lucide="alert-circle"></i> 無法更新 GoFreight。請稍後再試。`;
                            statusMessage.classList.add('error');
                            statusMessage.classList.remove('hidden');
                        }
                        
                        // 確保圖標正確顯示
                        if (typeof lucide !== 'undefined') {
                            try {
                                lucide.createIcons();
                            } catch (error) {
                                console.error("Error creating icons for status message:", error);
                            }
                        }
                    }, 1000);
                });
            }
        });
    </script>
</body>
</html>



